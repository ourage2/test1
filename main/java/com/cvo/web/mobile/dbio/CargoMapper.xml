<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cargo">
	
	<select id="cdCargoList" parameterType="map" resultType="box">
		SELECT 
			  DEV_ID AS CD
			, DEV_NM AS NM
		FROM TB_CARGO_DEV
		WHERE USE_YN = 'Y'
		AND AGENT_CD = #{sBox.agentCd}
	</select>
	
	<!-- 온도내역 조회 -->
	<select id="tempList" parameterType="map" resultType="box">
		SELECT
			  ROW_NUMBER() OVER(ORDER BY A.DEV_DT) AS RNUM
			, A.DEV_DT
			, B.CH_CNT
			, CASE 
				  WHEN B.CH_CNT = 1 THEN CAST(CAST(A.CH1 / 10.0 AS NUMERIC(4,1)) AS VARCHAR)
				  WHEN B.CH_CNT = 2 THEN CONCAT(CAST(A.CH1 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH2 / 10.0 AS NUMERIC(4,1)))
				  WHEN B.CH_CNT = 3 THEN CONCAT(CAST(A.CH1 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH2 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH3 / 10.0 AS NUMERIC(4,1)))
				  WHEN B.CH_CNT = 4 THEN CONCAT(CAST(A.CH1 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH2 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH3 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH4 / 10.0 AS NUMERIC(4,1)))
				  WHEN B.CH_CNT = 5 THEN CONCAT(CAST(A.CH1 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH2 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH3 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH4 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH5 / 10.0 AS NUMERIC(4,1)))
				  WHEN B.CH_CNT = 6 THEN CONCAT(CAST(A.CH1 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH2 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH3 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH4 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH5 / 10.0 AS NUMERIC(4,1)), '/', CAST(A.CH6 / 10.0 AS NUMERIC(4,1)))
			  END AS CH
			, CAST(A.CH1 / 10.0 AS NUMERIC(4, 1)) AS CH1
			, CAST(A.CH2 / 10.0 AS NUMERIC(4, 1)) AS CH2
			, CAST(A.CH3 / 10.0 AS NUMERIC(4, 1)) AS CH3
			, CAST(A.CH4 / 10.0 AS NUMERIC(4, 1)) AS CH4
			, CAST(A.CH5 / 10.0 AS NUMERIC(4, 1)) AS CH5
			, CAST(A.CH6 / 10.0 AS NUMERIC(4, 1)) AS CH6
		 	, CASE
				WHEN C.VIO_LONG_CNT > 0 THEN '온도위반'
				WHEN C.VIO_CNT > 0 THEN '온도이상'
			  END AS EVENT
		FROM TB_CARGO_HIST A WITH(NOLOCK)
		INNER JOIN TB_CARGO_DEV B WITH(NOLOCK)
			ON B.DEV_ID = A.DEV_ID
			AND B.USE_YN = 'Y'
		LEFT OUTER JOIN TB_CARGO_TEMP_VIO C WITH(NOLOCK)
			ON C.DEV_ID = A.DEV_ID
			AND C.DEV_DT = A.DEV_DT
			AND C.EVT_FLAG = '1'
		WHERE DATEDIFF(DAY, A.DEV_DT, CAST(#{srchDt} AS DATE)) = 0
		AND A.DEV_ID = #{srchDevId}
	</select>
	
</mapper>