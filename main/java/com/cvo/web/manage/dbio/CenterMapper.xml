<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="center">

	<sql id="carRest">
		DECLARE @STR_DT DATETIME;
		DECLARE @END_DT DATETIME;

		<choose>
			<when test='srchStrDt != null and srchStrDt != ""'>
				SET @STR_DT = CAST(#{srchStrDt} AS DATETIME);
			</when>
			<when test='srchDt != null and srchDt != ""'>
				SET @STR_DT = CAST(#{srchDt} AS DATETIME);
			</when>
		</choose>

		<choose>
			<when test='srchEndDt != null and srchEndDt != ""'>
				SET @END_DT = CAST(#{srchEndDt} AS DATETIME);
			</when>
			<when test='srchDt != null and srchDt != ""'>
				SET @END_DT = CAST(#{srchDt} AS DATETIME);
			</when>
		</choose>

		WITH REST1 AS (
			SELECT
				 CAST(@STR_DT AS DATE) AS REST_DATE
				,DATEPART(DAY, @STR_DT) AS REST_DAY
				,CONVERT(VARCHAR(6), @STR_DT, 112) AS STD_YM

			UNION ALL
			SELECT
				 DATEADD(DAY, 1, REST_DATE) AS REST_DATE
				,DATEPART(DAY, DATEADD(DAY, 1, REST_DATE)) AS REST_DAY
				,CONVERT(VARCHAR(6), DATEADD(DAY, 1, REST_DATE), 112) AS STD_YM
			FROM REST1 A
			WHERE DATEADD(DAY, 1, REST_DATE) &lt; CAST(@END_DT AS DATE)
		)
		,REST2 AS (
			SELECT
				 A.CAR_ID
				,A.STD_YM
				,B.REST_DATE
				,CASE B.REST_DAY
					WHEN 1 THEN DAY1
					WHEN 2 THEN DAY2
					WHEN 3 THEN DAY3
					WHEN 4 THEN DAY4
					WHEN 5 THEN DAY5
					WHEN 6 THEN DAY6
					WHEN 7 THEN DAY7
					WHEN 8 THEN DAY8
					WHEN 9 THEN DAY9
					WHEN 10 THEN DAY10
					WHEN 11 THEN DAY11
					WHEN 12 THEN DAY12
					WHEN 13 THEN DAY13
					WHEN 14 THEN DAY14
					WHEN 15 THEN DAY15
					WHEN 16 THEN DAY16
					WHEN 17 THEN DAY17
					WHEN 18 THEN DAY18
					WHEN 19 THEN DAY19
					WHEN 20 THEN DAY20
					WHEN 21 THEN DAY21
					WHEN 22 THEN DAY22
					WHEN 23 THEN DAY23
					WHEN 24 THEN DAY24
					WHEN 25 THEN DAY25
					WHEN 26 THEN DAY26
					WHEN 27 THEN DAY27
					WHEN 28 THEN DAY28
					WHEN 29 THEN DAY29
					WHEN 30 THEN DAY30
					WHEN 31 THEN DAY31
				END AS REST_CD
			FROM TB_CAR_REST A
			INNER JOIN REST1 B
				ON B.STD_YM = A.STD_YM
			<where>
				<if test='carId != null and carId != ""'>
					AND A.CAR_ID = #{carId}
				</if>
			</where>
		)
	</sql>

	<sql id="carTempSearch">
		<if test='srchWord != null and srchWord != ""'>
			<if test='srchMethod == "carNo"'>
				AND T1.CAR_NO LIKE '%' + #{srchWord} + '%'
			</if>
			<if test='srchMethod == "drvNm"'>
				AND T1.DRV_NM LIKE '%' + #{srchWord} + '%'
			</if>
		</if>

		<if test='srchCenterCd != null and srchCenterCd != ""'>
			AND (CASE WHEN T1.BIZ_SHOW_CD = 'T' THEN '9999' ELSE T1.CENTER_CD END) = #{srchCenterCd}
		</if>
	</sql>

	<sql id="cargoTempSearch">
		<if test='srchWord != null and srchWord != ""'>
			AND T1.CARGO_NM LIKE '%' + #{srchWord} + '%'
		</if>
		<if test='srchCenterCd != null and srchCenterCd != ""'>
			AND T1.CENTER_CD = #{srchCenterCd}
		</if>
		<if test='srchDevId != null and srchDevId != ""'>
			AND T1.DEV_ID = #{srchDevId}
		</if>
	</sql>

	 <!-- 대리점 배송 모니터링 - 선적 리스트 -->
	 <select id="agentDeliList" parameterType="map" resultType="box">
		SELECT
				T1.CAR_ID
				, T1.CAR_NO
				, T1.DRV_NM
				, DBO.FC_GET_DP_PHONE(T1.DRV_HP_NO) AS DRV_HP_NO
				, T2.SHIP_NO
		FROM TB_CAR T1 WITH (NOLOCK), TB_DELI T2 WITH (NOLOCK)
		WHERE 1=1
		AND T1.CAR_ID = T2.CAR_ID
		AND T2.SHIP_REQ_DATE &gt;= CONVERT(DATE, DATEADD(D, 0, GETDATE())) AND T2.SHIP_REQ_DATE &lt;= CONVERT(DATE, DATEADD(D, 2, GETDATE()))
		AND T1.AGENT_CD IS NULL
		AND T1.USE_YN = 'Y'
		AND T1.CENTER_CD = '2700'
		<!-- AND T1.CAR_ID = '61590'
		AND T2.SHIP_NO = '0013321282' -->
		ORDER BY T1.CAR_ID, T2.SHIP_NO, T2.SHIP_REQ_DATE
	 </select>

	 <!-- 대리점 배송 모니터링 - 상세 리스트 -->
	 <select id="agentDeliDtlList" parameterType="map" resultType="box">
	 	SELECT
				T1.SEQ
				, T1.CAR_ID
				, T2.CAR_NO
				, T2.DRV_NM
				, DBO.FC_GET_DP_PHONE(T2.DRV_HP_NO) AS DRV_HP_NO
				, T1.AGENT_CD
				, T3.AGENT_NM
				, T1.SHIP_NO
				, T1.DELI_NO
				, T1.SHIP_REQ_DATE
				, T1.ARR_DT
				, T1.START_DT
				, T1.TURN_YN
				, T1.ZONE_TYPE
				, T1.ZONE_FLAG
				, T1.EVT_FLAG
				, T4.CAR_DELI_DT
				, T4.CAR_DELI_YN
				, T4.CENTER_RDY_DT
				, T4.DELIY_DIV
				, ISNULL(CONVERT(VARCHAR, T1.ARR_GAP_SEC / 60), '') AS ARR_GAP_SEC
				, T1.AGENT_DELAY_YN
				, ISNULL(CONVERT(VARCHAR, T1.AGENT_GAP_SEC / 60), '') AS AGENT_GAP_SEC
		FROM TB_CAR_ZONE_IO T1 WITH (NOLOCK), TB_CAR T2 WITH (NOLOCK), TB_AGENT T3 WITH (NOLOCK), TB_DELI T4 WITH (NOLOCK)
		WHERE 1=1
		AND T1.CAR_ID = T2.CAR_ID
		AND T1.AGENT_CD = T3.AGENT_CD
		AND T1.CAR_ID = T4.CAR_ID
		AND T1.SHIP_NO = T4.SHIP_NO
		AND T4.CENTER_CD = '2700'
		<!-- AND T1.CAR_ID = '61590'
		AND T1.SHIP_NO = '0013321282' -->
		ORDER BY T1.CAR_ID, T1.SHIP_NO, T1.ZONE_TYPE, T1.ARR_DT, T1.SHIP_REQ_DATE
	 </select>

	<!-- 실시간 온도 모니터링 - 차량 -->
	<select id="tempNowList" parameterType="map" resultType="box">
		WITH TEMP_TREE AS (
			SELECT
				'_ROOT_' AS GRP_CD
				,CENTER_CD
				,'' AS CAR_ID
				,CENTER_NM AS CAR_NO
				,'' AS CAR_TID
				,'' AS DRV_NM
				,'' AS TURN_ON_OFF
				,CENTER_CD AS TREE_KEY
				,CASE WHEN A.CENTER_CD = '9999' THEN (
							SELECT CONVERT(VARCHAR, COUNT(1)) FROM TB_CAR T1 WITH (NOLOCK) WHERE T1.CAR_NO &lt;&gt; '' AND T1.USE_YN = 'Y'
							AND T1.BIZ_SHOW_CD = 'T' AND CHARINDEX('012', T1.CAR_TID) &gt; 0
							<include refid="carTempSearch" />
						)
					ELSE (
						SELECT CONVERT(VARCHAR, COUNT(1)) FROM TB_CAR T1 WITH (NOLOCK) WHERE T1.CENTER_CD = A.CENTER_CD AND T1.CAR_NO &lt;&gt; '' AND T1.USE_YN = 'Y'
						AND T1.BIZ_SHOW_CD = 'D' AND CHARINDEX('012', T1.CAR_TID) &gt; 0
						<include refid="carTempSearch" />
					)
				END AS CNT_CAR
				,XPOS
				,YPOS
				,NULL AS CH1
				,NULL AS CH2
				,'' AS CH1_VIO
				,'' AS CH2_VIO
				,0 AS LV
				,'false' AS LEAF
				,'false' AS EX
				,'' AS LAST_TEMP_DT
			FROM TB_CENTER A WITH (NOLOCK)
			WHERE 1=1
			AND USE_YN = 'Y'
			AND CENTER_CD NOT IN ('1100', '2200', '2600')
			UNION
			SELECT
				CASE WHEN T1.BIZ_SHOW_CD = 'T' THEN '9999' ELSE T1.CENTER_CD END AS GRP_CD
				, CASE WHEN T1.BIZ_SHOW_CD = 'T' THEN '9999' ELSE T1.CENTER_CD END AS CENTER_CD
				,T1.CAR_ID
				--,CASE WHEN T1.BIZ_SHOW_CD = 'T' THEN (SELECT '[' + CENTER_NM + '] ' + T1.CAR_NO FROM TB_CENTER WITH (NOLOCK) WHERE CENTER_CD = T1.CENTER_CD) ELSE T1.CAR_NO END CAR_NO
				,T1.CAR_NO AS CAR_NO
				,IIF(T1.CAR_TID = '00000000000', '', DBO.FC_GET_DP_PHONE(T1.CAR_TID)) AS CAR_TID
				,T1.DRV_NM
				,CASE WHEN T2.TURN_YN = 'Y' THEN 'ON' WHEN T2.TURN_YN = 'N' THEN 'OFF' ELSE '' END AS TURN_ON_OFF
				,T1.CENTER_CD + '_' + T1.CAR_ID AS TREE_KEY
				,'' AS CNT_CAR
				,T2.XPOS
				,T2.YPOS
				,ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T2.CH1) / 10)), '-') AS CH1
				,ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T2.CH2) / 10)), '-') AS CH2
				,CASE WHEN T2.CH1 IS NOT NULL AND T1.CH1_MIN IS NOT NULL AND T1.CH1_MAX IS NOT NULL THEN
					CASE WHEN T2.CH1 &lt; T1.CH1_MIN * 10 OR T2.CH1 &gt; T1.CH1_MAX * 10 THEN 'E' ELSE '' END
				ELSE '' END AS CH1_VIO
				,CASE WHEN T2.CH2 IS NOT NULL AND T1.CH2_MIN IS NOT NULL AND T1.CH2_MAX IS NOT NULL THEN
					CASE WHEN T2.CH2 &lt; T1.CH2_MIN * 10 OR T2.CH2 &gt; T1.CH2_MAX * 10 THEN 'E' ELSE '' END
				ELSE '' END AS CH2_VIO
				,1 AS LV
				,'true' AS LEAF
				,'false' AS EX
				,CONVERT(VARCHAR, T1.LAST_TEMP_DT, 120) AS LAST_TEMP_DT
			FROM TB_CAR T1 WITH (NOLOCK) LEFT JOIN TB_CAR_HIST T2 WITH (NOLOCK)
			ON T1.CAR_ID = T2.CAR_ID AND T1.LAST_TEMP_DT = T2.DEV_DT AND T2.LOG_DIV = 'D' AND T2.INSERT_ID = 'S1_TEMP_LAST'
			WHERE 1=1
			AND T1.USE_YN = 'Y'
			AND T1.CENTER_CD IS NOT NULL
			AND CHARINDEX('012', T1.CAR_TID) &gt; 0
			AND T1.CAR_NO &lt;&gt; ''
			<include refid="carTempSearch" />
		)
		SELECT
			GRP_CD
			,CENTER_CD
			,CAR_ID
			,CASE WHEN ISNUMERIC(CNT_CAR) &gt; 0 THEN CAR_NO + '(' + CNT_CAR + ')' ELSE CAR_NO END CAR_NO
			,CAR_TID
			,DRV_NM
			,TURN_ON_OFF
			,TREE_KEY
			,CNT_CAR
			,XPOS
			,YPOS
			,CH1
			,CH2
			,CH1_VIO
			,CH2_VIO
			,LV
			,CASE WHEN CNT_CAR = '0' THEN 'true' ELSE LEAF END AS LEAF
			,EX
			,LAST_TEMP_DT
		FROM TEMP_TREE
		WHERE 1=1
		<if test='!sessCenterCdList.isEmpty and sessCenterCdList.size != 0'>
			AND CENTER_CD IN
			<foreach item="item" collection="sessCenterCdList" open="(" close=")" separator=",">
				#{item.key}
			</foreach>
		</if>
		ORDER BY CENTER_CD, LV, CAR_NO
	</select>

	<!-- 실시간 온도 모니터링 - 차량운행정보 대수 -->
	<select id="tempNowOnOffCnt" parameterType="map" resultType="box">
		SELECT 'A' + CONVERT(VARCHAR, T1.NUMBER) AS TURN_ON_OFF, COUNT(1) AS CNT
		FROM MASTER..SPT_VALUES T1 LEFT JOIN (
			SELECT
				CASE WHEN T1.LAST_TEMP_DT >= CONVERT(DATE, GETDATE()) THEN 'A1' ELSE 'A2' END AS TURN_ON_OFF
			FROM TB_CAR T1 WITH (NOLOCK) LEFT JOIN TB_CAR_HIST T2 WITH (NOLOCK)
			ON T1.CAR_ID = T2.CAR_ID AND T1.LAST_TEMP_DT = T2.DEV_DT AND T2.LOG_DIV = 'D' AND T2.INSERT_ID = 'S1_TEMP_LAST'
			WHERE 1=1
			AND T1.USE_YN = 'Y'
			AND T1.CENTER_CD IS NOT NULL
			AND T1.CAR_NO &lt;&gt; ''
			AND CHARINDEX('012', T1.CAR_TID) > 0
			<if test='!sessCenterCdList.isEmpty and sessCenterCdList.size != 0'>
				AND T1.CENTER_CD IN
				<foreach item="item" collection="sessCenterCdList" open="(" close=")" separator=",">
					#{item.key}
				</foreach>
			</if>
		) T2
		ON 'A' + CONVERT(VARCHAR, T1.NUMBER) = T2.TURN_ON_OFF
		WHERE
		T1.TYPE = 'P'
		AND T1.NUMBER &gt;= 1 AND T1.NUMBER &lt;= 2
		GROUP BY 'A' + CONVERT(VARCHAR, T1.NUMBER)
	</select>

	<!-- 실시간 온도 모니터링 - 차량세부내역 -->
	<select id="tempNowDtlList" parameterType="map" resultType="box">
		SELECT
			T1.CENTER_CD
			,T1.CAR_ID
			,T1.CAR_NO
			,IIF(T1.CAR_TID = '00000000000', '', DBO.FC_GET_DP_PHONE(T1.CAR_TID)) AS CAR_TID
			,T1.DRV_NM
			,DBO.FC_GET_DP_PHONE(T1.DRV_HP_NO) AS DRV_HP_NO
			,CASE WHEN T2.TURN_YN = 'Y' THEN 'ON' WHEN T2.TURN_YN = 'N' THEN 'OFF' ELSE '' END AS TURN_ON_OFF
			,T2.XPOS
			,T2.YPOS
			,T2.DAY_TOT_DIS / 1000 AS DAY_DIS
			,T2.SPD
			,ISNULL(T2.JIBUN_ADDR, '') AS JIBUN_ADDR
			,ISNULL(T2.ROAD_ADDR, '') AS ROAD_ADDR
			,ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), CH1) / 10)), '-') AS CH1
			,ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), CH2) / 10)), '-') AS CH2
			,CASE WHEN T2.CH1 IS NOT NULL AND T1.CH1_MIN IS NOT NULL AND T1.CH1_MAX IS NOT NULL THEN
					CASE WHEN T2.CH1 &lt; T1.CH1_MIN * 10 OR T2.CH1 &gt; T1.CH1_MAX * 10 THEN 'E' ELSE '' END
				ELSE '' END AS CH1_VIO
			,CASE WHEN T2.CH2 IS NOT NULL AND T1.CH2_MIN IS NOT NULL AND T1.CH2_MAX IS NOT NULL THEN
					CASE WHEN T2.CH2 &lt; T1.CH2_MIN * 10 OR T2.CH2 &gt; T1.CH2_MAX * 10 THEN 'E' ELSE '' END
				ELSE '' END AS CH2_VIO
			,CONVERT(VARCHAR, T1.LAST_TEMP_DT, 120) AS LAST_TEMP_DT
			,'-' AS RECENT_ON_DT
			,ISNULL((SELECT CONVERT(VARCHAR(16), MAX(DEV_DT), 120) FROM TB_CAR_HIST WITH (NOLOCK)
				WHERE CAR_ID = T1.CAR_ID AND TURN_YN = 'N' AND LOG_DIV = 'D' AND INSERT_ID = 'S1_TEMP_LAST' AND DEV_DT  &lt; T1.LAST_TEMP_DT)
				, '') AS RECENT_OFF_DT
			,1 AS LV
		FROM TB_CAR T1 WITH (NOLOCK) LEFT JOIN TB_CAR_HIST T2 WITH (NOLOCK)
		ON T1.CAR_ID = T2.CAR_ID AND T1.LAST_TEMP_DT = T2.DEV_DT AND T2.LOG_DIV = 'D' AND T2.INSERT_ID = 'S1_TEMP_LAST'
		WHERE 1=1
		AND T1.USE_YN = 'Y'
		AND T1.CAR_ID = #{carId}
		AND T1.CENTER_CD IS NOT NULL
		<if test='!sessCenterCdList.isEmpty and sessCenterCdList.size != 0'>
			AND T1.CENTER_CD IN
			<foreach item="item" collection="sessCenterCdList" open="(" close=")" separator=",">
				#{item.key}
			</foreach>
		</if>
	</select>

	<!-- 실시간 온도 모니터링 - 차량 일별 배송처 리스트 -->
	<select id="dayCarDeliDtlList" parameterType="map" resultType="box">
		SELECT
			T1.CAR_ID
			, T1.AGENT_CD
			, T2.AGENT_NM
			, T1.SHIP_NO
			, T1.DELI_NO
			, CONVERT(VARCHAR, T1.SHIP_REQ_DATE, 23) AS SHIP_REQ_DATE
			, CONVERT(VARCHAR, T1.ARR_DT, 120) AS ARR_DT
			, CONVERT(VARCHAR, T1.START_DT, 120) AS START_DT
			, CONVERT(VARCHAR, T1.ARR_EXPECT_DT, 120) AS ARR_EXPECT_DT
			, T1.DELAY_YN
			, T1.AGENT_DELAY_YN
			, T2.XPOS
			, T2.YPOS
		FROM TB_CAR_ZONE_IO T1 WITH (NOLOCK), TB_AGENT T2 WITH (NOLOCK)
		WHERE T1.AGENT_CD = T2.AGENT_CD
			AND T1.CAR_ID = #{carId}
			AND T1.ZONE_TYPE = '2'
			AND T2.USE_YN = 'Y'
			AND T2.XPOS &gt; 30
			AND T2.YPOS &gt; 30
			AND T1.SHIP_REQ_DATE BETWEEN DATEADD(D, -1, CONVERT(DATE, GETDATE())) AND DATEADD(D, 2, CONVERT(DATE, GETDATE()))
	</select>

	<!-- 실시간 온도 모니터링 - 창고 -->
	<select id="tempNowCargoList" parameterType="map" resultType="box">
		WITH TEMP_TREE AS (
			SELECT
				'_ROOT_' AS GRP_CD
				, CENTER_CD
				, '' AS DEV_ID
				, CENTER_NM AS CARGO_NM
				, '' AS DEV_NM
				, (
					SELECT CONVERT(VARCHAR, COUNT(1)) FROM TB_CARGO_DEV T1 WITH (NOLOCK) WHERE T1.CENTER_CD = A.CENTER_CD AND T1.USE_YN = 'Y' AND T1.CENTER_CD IS NOT NULL
					<include refid="cargoTempSearch" />
				) AS CNT_CARGO
				, '' AS CH_CNT
				, CENTER_CD AS TREE_KEY
				, NULL AS CH1_NM,  NULL AS CH1, NULL AS CH1_MIN, NULL AS CH1_MAX
				, NULL AS CH2_NM,  NULL AS CH2, NULL AS CH2_MIN, NULL AS CH2_MAX
				, NULL AS CH3_NM,  NULL AS CH3, NULL AS CH3_MIN, NULL AS CH3_MAX
				, NULL AS CH4_NM,  NULL AS CH4, NULL AS CH4_MIN, NULL AS CH4_MAX
				, NULL AS CH5_NM,  NULL AS CH5, NULL AS CH5_MIN, NULL AS CH5_MAX
				, NULL AS CH6_NM,  NULL AS CH6, NULL AS CH6_MIN, NULL AS CH6_MAX
				,0 AS LV
				,'false' AS LEAF
				,'false' AS EX
				,'' AS LAST_TEMP_DT
			FROM TB_CENTER A WITH (NOLOCK)
			WHERE 1=1
			AND USE_YN = 'Y'
			AND CENTER_CD NOT IN ('1100', '9999')
			UNION
			SELECT
				T1.CENTER_CD AS GRP_CD
				, T1.CENTER_CD
				, T1.DEV_ID
				, T1.CARGO_NM
				, T1.DEV_NM
				, '' AS CNT_CARGO
				, CONVERT(VARCHAR, T1.CH_CNT) AS CH_CNT
				, T1.CENTER_CD + '_' + T1.DEV_ID AS TREE_KEY
				, T1.CH1_NM
				, CASE WHEN T2.CH1 = -500 THEN '' ELSE ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T2.CH1) / 10)), '') END AS CH1
				, T1.CH1_MIN
				, T1.CH1_MAX
				, T1.CH2_NM
				, CASE WHEN T2.CH2 = -500 THEN '' ELSE ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T2.CH2) / 10)), '') END AS CH2
				, T1.CH2_MIN
				, T1.CH2_MAX
				, T1.CH3_NM
				, CASE WHEN T2.CH3 = -500 THEN '' ELSE ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T2.CH3) / 10)), '') END AS CH3
				, T1.CH3_MIN
				, T1.CH3_MAX
				, T1.CH4_NM
				, CASE WHEN T2.CH4 = -500 THEN '' ELSE ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T2.CH4) / 10)), '') END AS CH4
				, T1.CH4_MIN
				, T1.CH4_MAX
				, T1.CH5_NM
				, CASE WHEN T2.CH5 = -500 THEN '' ELSE ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T2.CH5) / 10)), '') END AS CH5
				, T1.CH5_MIN
				, T1.CH5_MAX
				, T1.CH6_NM
				, CASE WHEN T2.CH6 = -500 THEN '' ELSE ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T2.CH6) / 10)), '') END AS CH6
				, T1.CH6_MIN
				, T1.CH6_MAX
				,1 AS LV
				,'true' AS LEAF
				,'false' AS EX
				,CONVERT(VARCHAR, T1.LAST_DEV_DT, 23) AS LAST_DEV_DT
			FROM TB_CARGO_DEV T1 WITH (NOLOCK) LEFT JOIN TB_CARGO_HIST T2 WITH (NOLOCK)
			ON T1.DEV_ID = T2.DEV_ID AND T1.LAST_DEV_DT = T2.DEV_DT
			WHERE 1=1
			AND T1.USE_YN = 'Y'
			AND T1.CENTER_CD IS NOT NULL
			--AND T1.LAST_DEV_DT &gt;= CONVERT(DATE, GETDATE()) AND T1.LAST_DEV_DT &lt; CONVERT(DATE, DATEADD(D, 1, GETDATE()))
			<include refid="cargoTempSearch" />
		)
		SELECT
			GRP_CD
			, CENTER_CD
			, DEV_ID
			, CARGO_NM
			, CNT_CARGO
			, CH_CNT
			, DEV_NM
			, ISNULL(CH1_NM, '-') AS CH1_NM
			, CH1
			, CH1_MIN
			, CH1_MAX
			, ISNULL(CH2_NM, '-') AS CH2_NM
			, CH2
			, CH2_MIN
			, CH2_MAX
			, ISNULL(CH3_NM, '-') AS CH3_NM
			, CH3
			, CH3_MIN
			, CH3_MAX
			, ISNULL(CH4_NM, '-') AS CH4_NM
			, CH4
			, CH4_MIN
			, CH4_MAX
			, ISNULL(CH5_NM, '-') AS CH5_NM
			, CH5
			, CH5_MIN
			, CH5_MAX
			, ISNULL(CH6_NM, '-') AS CH6_NM
			, CH6
			, TREE_KEY
			, LV
			, CASE WHEN CNT_CARGO = '0' THEN 'true' ELSE LEAF END AS LEAF
			, EX
			, LAST_TEMP_DT
			, CASE WHEN ISNUMERIC(CH1) &gt; 0 AND LV = 1 THEN
					CASE WHEN CONVERT(NUMERIC(3, 1), CH1) BETWEEN CH1_MIN AND CH1_MAX THEN 'S' ELSE 'E' END
				ELSE '' END CH1_VIO
			, CASE WHEN ISNUMERIC(CH2) &gt; 0 AND LV = 1 THEN
					CASE WHEN CONVERT(NUMERIC(3, 1), CH2) BETWEEN CH2_MIN AND CH2_MAX THEN 'S' ELSE 'E' END
				ELSE '' END CH2_VIO
			, CASE WHEN ISNUMERIC(CH3) &gt; 0 AND LV = 1 THEN
					CASE WHEN CONVERT(NUMERIC(3, 1), CH3) BETWEEN CH3_MIN AND CH3_MAX THEN 'S' ELSE 'E' END
				ELSE '' END CH3_VIO
			, CASE WHEN ISNUMERIC(CH4) &gt; 0 AND LV = 1 THEN
					CASE WHEN CONVERT(NUMERIC(3, 1), CH4) BETWEEN CH4_MIN AND CH4_MAX THEN 'S' ELSE 'E' END
				ELSE '' END CH4_VIO
			, CASE WHEN ISNUMERIC(CH5) &gt; 0 AND LV = 1 THEN
					CASE WHEN CONVERT(NUMERIC(3, 1), CH5) BETWEEN CH5_MIN AND CH5_MAX THEN 'S' ELSE 'E' END
				ELSE '' END CH5_VIO
			, CASE WHEN ISNUMERIC(CH6) &gt; 0 AND LV = 1 THEN
					CASE WHEN CONVERT(NUMERIC(3, 1), CH6) BETWEEN CH6_MIN AND CH6_MAX THEN 'S' ELSE 'E' END
				ELSE '' END CH6_VIO
		FROM TEMP_TREE
		WHERE 1=1
		<if test='!sessCenterCdList.isEmpty and sessCenterCdList.size != 0'>
				<foreach item="item" collection="sessCenterCdList" open="AND CENTER_CD IN (" close=")" separator=",">
					#{item.key}
				</foreach>
		</if>
		ORDER BY CENTER_CD, LV, CARGO_NM
	</select>

	<!-- 일자별차량 운행현황 조회 - 선적정보 -->
	<select id="dayCarNowList" parameterType="map" resultType="box">
		SELECT
			ROW_NUMBER() OVER(ORDER BY T1.SHIP_REQ_DATE, T1.SHIP_NO) AS RNUM
			, T1.SHIP_NO
			, T1.SHIP_REQ_DATE
			, T1.CENTER_CD
			, T1.CENTER_NM
			, T1.CAR_CENTER_NM
			, T1.CENTER_RDY_DT
			, T1.DELI_YN
			, T1.CAR_ID
			, T1.CAR_NO
			, T1.BIZ_CD
			, CASE WHEN T1.BIZ_CD = 'D' THEN '배송' ELSE '수송' END STR_BIZ_CD
			, T1.CH_CNT
			, T1.DELIY_YN
			, T1.DELIY_DIV
		FROM (
			SELECT
				A.*, B.CAR_NO, C.CENTER_NM AS CAR_CENTER_NM
				, (SELECT TOP 1 BIZ_CD FROM TB_DELI_DTL WITH (NOLOCK) WHERE SHIP_NO = A.SHIP_NO) AS BIZ_CD
				, B.CH_CNT
				, CASE WHEN ISNULL(A.DELIY_DT, '') = '' THEN 'N' ELSE 'Y' END AS DELIY_YN
			FROM TB_DELI A WITH (NOLOCK)
			INNER JOIN TB_CAR B WITH (NOLOCK)
				ON A.CAR_ID = B.CAR_ID
			LEFT JOIN TB_CENTER C WITH (NOLOCK)
				ON B.CENTER_CD = C.CENTER_CD
			WHERE 1=1
			<choose>
				<when test='srchDateFlag.equals("P")'>
					AND A.DELIY_DT &gt;= CONVERT(DATETIME, #{srchShipReqDate})  AND A.DELIY_DT &lt; DATEADD(D, 1, CONVERT(DATETIME, #{srchShipReqDate}))
				</when>
				<otherwise>
					AND A.SHIP_REQ_DATE &gt;= CONVERT(DATETIME, #{srchShipReqDate})
					AND
					(
						A.DELIY_DT IS NULL OR ( A.DELIY_DT &gt;= CONVERT(DATETIME, #{srchShipReqDate}) AND A.DELIY_DT &lt; DATEADD(D, 1, CONVERT(DATETIME, #{srchShipReqDate})) )
					)
				</otherwise>
			</choose>
		) T1
		WHERE 1=1

		<if test='srchBizCd != null and srchBizCd != ""'>
			AND T1.BIZ_CD = #{srchBizCd}
		</if>
		<if test='srchCenterCd != null and srchCenterCd != ""'>
			AND T1.CENTER_CD = #{srchCenterCd}
		</if>
		<if test='srchShipNo != null and srchShipNo != ""'>
			AND T1.SHIP_NO LIKE '%' + #{srchShipNo} + '%'
		</if>
		<if test='srchCarNo != null and srchCarNo != ""'>
			AND T1.CAR_NO LIKE '%' + #{srchCarNo} + '%'
		</if>
		<if test='!sessCenterCdList.isEmpty and sessCenterCdList.size != 0'>
				AND T1.CENTER_CD IN
				<foreach item="item" collection="sessCenterCdList" open="(" close=")" separator=",">
					#{item.key}
				</foreach>
		</if>
	</select>

	<select id="dayCarNowCenter" parameterType="map" resultType="box">
		SELECT
			A.CENTER_CD
			, A.CENTER_NM
			, B.XPOS
			, B.YPOS
		FROM TB_DELI A WITH (NOLOCK)
		INNER JOIN TB_AGENT B WITH (NOLOCK)
			ON CONCAT('P', A.CENTER_CD) = B.AGENT_CD
		WHERE 1=1
		AND A.CAR_ID = #{carId}
		AND A.SHIP_REQ_DATE = #{shipReqDate}
		AND A.SHIP_NO = #{shipNo}
	</select>

	<!-- 일자별차량 운행현황 조회 - 납품정보 -->
	<select id="dayCarNowDtlList" parameterType="map" resultType="box">
		SELECT
			ROW_NUMBER() OVER(ORDER BY D.ARR_EXPECT_DT) AS RNUM
			, A.SHIP_NO
			, A.AGENT_CD
			, A.DELI_NO
			, C.AGENT_NM
			, B.SHIP_REQ_DATE
			, CONVERT(VARCHAR(5), D.ARR_EXPECT_DT, 108) AS ARR_EXPECT_DT
			, CONVERT(VARCHAR(5), D.ARR_DT, 108) AS ARR_DT
			, ISNULL(CONVERT(VARCHAR, D.ARR_GAP_SEC / 60), '') AS ARR_GAP_SEC
			, D.AGENT_DELAY_YN
			, ISNULL(CONVERT(VARCHAR, D.AGENT_GAP_SEC / 60), '') AS AGENT_GAP_SEC
			, C.XPOS
			, C.YPOS
		FROM TB_DELI_DTL A WITH (NOLOCK)
		INNER JOIN TB_DELI B WITH (NOLOCK)
			ON A.SHIP_NO = B.SHIP_NO
		INNER JOIN TB_AGENT C WITH (NOLOCK)
			ON A.AGENT_CD = C.AGENT_CD
		INNER JOIN TB_CAR_ZONE_IO D WITH (NOLOCK)
			ON B.SHIP_NO = D.SHIP_NO
			AND A.DELI_NO = D.DELI_NO
			AND B.CAR_ID = D.CAR_ID
			AND C.AGENT_CD = D.AGENT_CD
		WHERE 1=1
		AND D.CAR_ID = #{carId}
		AND B.SHIP_NO = #{shipNo}
		<if test='!sessCenterCdList.isEmpty and sessCenterCdList.size != 0'>
				AND B.CENTER_CD IN
				<foreach item="item" collection="sessCenterCdList" open="(" close=")" separator=",">
					#{item.key}
				</foreach>
		</if>
		ORDER BY ARR_EXPECT_DT
	</select>

	<!-- 일자별차량 운행현황 조회 - 운행정보 -->
	<select id="dayCarNowHistList" parameterType="map" resultType="box">
		SELECT
			<choose>
				<when test='sortColumn != null and sortColumn != ""'>
					ROW_NUMBER() OVER(ORDER BY ${sortColumn} ${sortOrder}) AS RNUM
				</when>
				<otherwise>
					ROW_NUMBER() OVER(ORDER BY DEV_DT) AS RNUM
				</otherwise>
			</choose>
			, CAR_ID
			, XPOS
			, YPOS
			, TURN_YN
			, SPD
			, DAY_DIS
			, CH1
			, CH2
			, CH3
			, CH4
			, DEV_DT
			, TEMP_DEV_DT
			, AGENT_NM
			, JIBUN_ADDR
			, ROAD_ADDR
			, FULL_DEV_DT
			, BIGO
		FROM (
			SELECT
				T1.CAR_ID
				, T1.XPOS
				, T1.YPOS
				, T1.TURN_YN
				, T1.SPD
				, T1.DAY_TOT_DIS / 1000 AS DAY_DIS
				, ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T1.CH1) / 10)), '-') AS CH1
				, ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T1.CH2) / 10)), '-') AS CH2
				, ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T1.CH3) / 10)), '-') AS CH3
				, ISNULL(CONVERT(VARCHAR, CONVERT(NUMERIC(3, 1), CONVERT(NUMERIC(3, 0), T1.CH4) / 10)), '-') AS CH4
				, CONVERT(VARCHAR, T1.DEV_DT, 108) AS DEV_DT
				, ISNULL(CONVERT(VARCHAR, T2.DEV_DT, 112), '') AS TEMP_DEV_DT
				, ISNULL(T3.AGENT_NM, '') AS AGENT_NM
				, ISNULL(T1.JIBUN_ADDR, '') AS JIBUN_ADDR
				, ISNULL(T1.ROAD_ADDR, '') AS ROAD_ADDR
				, T1.DEV_DT AS FULL_DEV_DT
				, CASE WHEN ISNULL(CONVERT(VARCHAR, T2.DEV_DT, 112), '') &lt;&gt; '' AND ISNULL(T3.AGENT_NM, '') &lt;&gt; '' THEN REPLACE(ISNULL(T3.AGENT_NM, ''), '||', '&lt;BR /&gt;') + '&lt;BR /&gt;온도이탈'
					WHEN ISNULL(CONVERT(VARCHAR, T2.DEV_DT, 112), '') &lt;&gt; '' AND ISNULL(T3.AGENT_NM, '') = '' THEN '온도이탈'
					WHEN ISNULL(CONVERT(VARCHAR, T2.DEV_DT, 112), '') = '' AND ISNULL(T3.AGENT_NM, '') &lt;&gt; '' THEN REPLACE(ISNULL(T3.AGENT_NM, ''), '||', '&lt;BR /&gt;')
					ELSE ''
				END AS BIGO
			FROM TB_CAR_HIST T1 WITH (NOLOCK) LEFT JOIN TB_CAR_TEMP_VIO T2 WITH (NOLOCK)
				ON T1.CAR_ID = T2.CAR_ID AND T1.DEV_DT = T2.DEV_DT AND T2.EVT_FLAG = '1' AND T1.INSERT_ID = 'S1_TEMP_LAST'
			LEFT JOIN (

				SELECT DISTINCT CAR_ID, SHIP_NO, ARR_DT AS EVT_DT, STUFF((
						SELECT '||' + A2.AGENT_NM + ' 도착'
						FROM TB_CAR_ZONE_IO A1 WITH (NOLOCK), TB_AGENT A2 WITH (NOLOCK)
						WHERE A1.AGENT_CD = A2.AGENT_CD
						AND A1.CAR_ID = #{carId}
						AND A1.SHIP_NO = #{shipNo}
						AND A1.ZONE_TYPE IN ('2', '3')
						AND A1.ARR_DT = A3.ARR_DT
						FOR XML PATH('')
					),1,2,'') AS AGENT_NM
				FROM TB_CAR_ZONE_IO A3 WITH (NOLOCK), TB_AGENT A4 WITH (NOLOCK)
				WHERE A3.AGENT_CD = A4.AGENT_CD
				AND A3.CAR_ID = #{carId}
				AND A3.SHIP_NO = #{shipNo}
				AND A3.ZONE_TYPE IN ('2', '3')
				AND A3.ARR_DT IS NOT NULL
				UNION
				SELECT DISTINCT CAR_ID, SHIP_NO, START_DT AS EVT_DT, STUFF((
						SELECT '||' + A2.AGENT_NM + ' 출발' +
							CASE WHEN A1.ZONE_TYPE = '1' THEN (
								SELECT IIF(AA.CENTER_RDY_DT IS NOT NULL, CONCAT('(', CONVERT(VARCHAR(8), AA.CENTER_RDY_DT, 108), ')'), '') FROM TB_DELI AA
								WHERE AA.CAR_ID = #{carId} AND AA.SHIP_NO = #{shipNo})
							ELSE ''
							END
						FROM TB_CAR_ZONE_IO A1 WITH (NOLOCK), TB_AGENT A2 WITH (NOLOCK)
						WHERE A1.AGENT_CD = A2.AGENT_CD
						AND A1.CAR_ID = #{carId}
						AND A1.SHIP_NO = #{shipNo}
						AND A1.ZONE_TYPE IN ('2', '1')
						AND A1.START_DT = A3.START_DT
						FOR XML PATH('')
					),1,2,'') AS AGENT_NM
				FROM TB_CAR_ZONE_IO A3 WITH (NOLOCK), TB_AGENT A4 WITH (NOLOCK)
				WHERE A3.AGENT_CD = A4.AGENT_CD
				AND A3.CAR_ID = #{carId}
				AND A3.SHIP_NO = #{shipNo}
				AND A3.ZONE_TYPE IN ('2', '1')
				AND A3.START_DT IS NOT NULL
				UNION
				SELECT
					CAR_ID, SHIP_NO, CENTER_RDY_DT AS EVT_DT, '공장 출발 대기' AS AGENT_NM
				FROM TB_DELI
				WHERE CAR_ID = #{carId}
				AND SHIP_NO = #{shipNo}
				AND CENTER_RDY_DT IS NOT NULL
				UNION
				SELECT
					CAR_ID, SHIP_NO, DELIY_DT AS EVT_DT, '납품완료' AS AGENT_NM
				FROM TB_DELI
				WHERE CAR_ID = #{carId}
				AND SHIP_NO = #{shipNo}
				AND DELIY_DT IS NOT NULL
			) T3
				ON T1.CAR_ID = T3.CAR_ID AND T1.DEV_DT = T3.EVT_DT
			INNER JOIN (
				SELECT (
					SELECT MIN(STD_DT)
					FROM (
						SELECT
							CASE WHEN ZONE_TYPE = '1' THEN START_DT
								WHEN ZONE_TYPE = '2' THEN ARR_DT
							END STD_DT
						FROM TB_CAR_ZONE_IO WITH (NOLOCK)
						WHERE CAR_ID = #{carId}
						AND SHIP_NO = #{shipNo}
						UNION
						SELECT
							CENTER_RDY_DT AS STD_DT
						FROM TB_DELI WITH (NOLOCK)
						WHERE CAR_ID = #{carId}
						AND SHIP_NO = #{shipNo}
					) T1
				) SDT, (
					SELECT ISNULL(MAX(STD_DT), GETDATE())
					FROM (
						SELECT
							CASE WHEN ZONE_TYPE IN ('2', '3') THEN ARR_DT
							END STD_DT
						FROM TB_CAR_ZONE_IO WITH (NOLOCK)
						WHERE CAR_ID = #{carId}
						AND SHIP_NO = #{shipNo}
						AND ARR_DT IS NOT NULL
						UNION
						SELECT
							DELIY_DT AS STD_DT
						FROM TB_DELI WITH (NOLOCK)
						WHERE CAR_ID = #{carId}
						AND SHIP_NO = #{shipNo}
						AND DELIY_DT IS NOT NULL
					) T2
				) AS EDT
			) T4
				ON 1=1
			WHERE 1=1
			AND T1.CAR_ID = #{carId}
			AND T1.LOG_DIV = 'D'
			AND T1.XPOS &gt; 0
			AND T1.YPOS &gt; 0
			AND (T1.DEV_DT &gt;= #{srchShipReqDate} AND T1.DEV_DT &lt; DATEADD(D, +1, #{srchShipReqDate}))
			AND (T1.DEV_DT &gt;= T4.SDT AND T1.DEV_DT &lt;= T4.EDT)
			AND T1.INSERT_ID = 'S1_TEMP_LAST'
	) TT
	</select>

	<!-- 일자별차량 운행현황 조회 - 전체 운행정보 -->
	<select id="dayCarAllHistList" parameterType="map" resultType="box">
		SELECT
			ROW_NUMBER() OVER(ORDER BY T1.DEV_DT) AS RNUM
			, T1.CAR_ID
			, T1.XPOS
			, T1.YPOS
		FROM TB_CAR_HIST T1 WITH (NOLOCK)
		WHERE 1=1
		AND T1.CAR_ID = #{carId}
		AND T1.DEV_DT &gt;= #{srchShipReqDate} AND T1.DEV_DT &lt; DATEADD(D, +1, #{srchShipReqDate})
		AND T1.LOG_DIV = 'D'
		AND T1.INSERT_ID = 'S1_TEMP_LAST'
		AND T1.XPOS &gt; 0
		AND T1.YPOS &gt; 0
	</select>

	<!-- 	 -->
	<sql id="dayCarDrvAnalCte">
		WITH T2 AS (
			SELECT
				  B.CENTER_NM
				, C.STD_DATE
				, D.CD_NM AS COMPANY_NM
				, A.CAR_ID
				, A.CAR_NO
				, A.DRV_NM
				, IIF(C.TOT_DIS IS NULL, '', CONCAT(C.TOT_DIS, 'km')) AS TOT_DIS
				, IIF(C.TOT_SEC IS NULL, '',
				   CASE
						WHEN C.TOT_SEC &lt; 3600 THEN CONCAT(C.TOT_SEC / 60, '분')
						ELSE CONCAT(C.TOT_SEC / 3600, '시간', IIF(C.TOT_SEC % 3600 &lt; 60, '', CONCAT(' ', C.TOT_SEC % 3600 / 60, '분')))
					END
				  ) AS TOT_TM
				, CONVERT(VARCHAR(5), C.LAST_AGENT_STR_DT, 108) AS LAST_AGENT_STR_TM
				, IIF(C.DRV_DIS IS NULL, '', CONCAT(C.DRV_DIS, 'km')) AS DRV_DIS
				, IIF(C.DRV_SEC IS NULL, '',
					CASE
						WHEN C.DRV_SEC &lt; 3600 THEN CONCAT(C.DRV_SEC / 60, '분')
						ELSE CONCAT(C.DRV_SEC / 3600, '시간', IIF(C.DRV_SEC % 3600 &lt; 60, '', CONCAT(' ', C.DRV_SEC % 3600 / 60, '분')))
					END
				  ) AS DRV_TM
				, C.SHIP_CNT
				, C.DELI_COMP_CNT
				, CONCAT(ISNULL(C.DELI_NOR_CNT, 0), '/', ISNULL(C.DELI_VIO_CNT, 0)) AS ARR_NOR_VIO_CNT
				, CONCAT(ISNULL(C.ARR_AGENT_NOR_CNT, 0), '/', ISNULL(C.ARR_AGENT_VIO_CNT, 0)) AS ARR_AGENT_NOR_VIO_CNT
				, C.INPUT_ARR_VIO_CNT
				, C.TEMP_TOT_CNT
				, C.TEMP_VIO_LONG_CNT
				, C.TEMP_HACCP_VIO_LONG_CNT
				, C.INPUT_TEMP_VIO_CNT
				, IIF(C.REST_CD = 'N', '',  F.CD_NM) AS REST_NM
				, A.CH_CNT
				, C.BIZ_CD
			FROM TB_CAR A WITH(NOLOCK)
			INNER JOIN TB_CENTER B WITH(NOLOCK)
				ON B.CENTER_CD = A.CENTER_CD
			INNER JOIN TB_CAR_STAT C WITH(NOLOCK)
				ON C.CAR_ID = A.CAR_ID
				AND C.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
				AND C.BIZ_CD = #{srchBizCd}
			LEFT OUTER JOIN TB_CD D
				ON D.GRP_CD = 'COMPANY_CD'
				AND D.CD = A.COMPANY_CD
			LEFT OUTER JOIN TB_CD F
				ON F.GRP_CD = 'REST_CD'
				AND F.CD = C.REST_CD
			<where>
				AND A.USE_YN = 'Y'
			   	AND (A.CAR_TID LIKE '012%' OR A.RENT_YN = 'Y')
				AND A.CAR_NO IS NOT NULL
				<if test='!srchCenterCdList.isEmpty and srchCenterCdList.size != 0'>
					<foreach item="item" collection="srchCenterCdList" open="AND (" separator=", A.CENTER_CD) > 0 OR " close=", A.CENTER_CD) > 0)">
						CHARINDEX(#{item.key}
					</foreach>
				</if>
				<if test='srchWord != null and srchWord != ""'>
					<if test='srchMethod == "companyNm"'>
						AND D.CD_NM LIKE '%' + #{srchWord} + '%'
					</if>
					<if test='srchMethod == "carNo"'>
						AND A.CAR_NO LIKE '%' + #{srchWord} + '%'
					</if>
					<if test='srchMethod == "drvNm"'>
						AND A.DRV_NM LIKE '%' + #{srchWord} + '%'
					</if>
				</if>
			</where>
		)
	</sql>

	<select id="dayCarDrvAnalCnt" parameterType="map" resultType="int">
		<include refid="dayCarDrvAnalCte"/>
		SELECT COUNT(*) AS CNT
		FROM T2 A
	</select>

	<!-- 일자별차량 운행내역 내역 -->
	<select id="dayCarDrvAnalList" parameterType="map" resultType="box">
		<include refid="dayCarDrvAnalCte"/>
		<include refid="cmn.pageStr" />
		SELECT
			<choose>
				<when test='sortColumn != null and sortColumn != ""'>
					ROW_NUMBER() OVER(ORDER BY ${sortColumn} ${sortOrder}) AS RNUM
				</when>
				<otherwise>
					ROW_NUMBER() OVER (ORDER BY A.STD_DATE, A.CENTER_NM) AS RNUM
				</otherwise>
			</choose>
			,A.CENTER_NM
			,A.STD_DATE
			,A.COMPANY_NM
			,A.CAR_ID
			,A.CAR_NO
			,A.DRV_NM
			,A.TOT_DIS
			,A.TOT_TM
			,A.LAST_AGENT_STR_TM
			,A.DRV_DIS
			,A.DRV_TM
			,A.SHIP_CNT
			,A.DELI_COMP_CNT
			,A.ARR_NOR_VIO_CNT
			,A.ARR_AGENT_NOR_VIO_CNT
			,A.INPUT_ARR_VIO_CNT
			,A.TEMP_TOT_CNT
			,A.TEMP_VIO_LONG_CNT
			,A.TEMP_HACCP_VIO_LONG_CNT
			,A.INPUT_TEMP_VIO_CNT
			,A.REST_NM
			,A.CH_CNT
			,A.BIZ_CD
		FROM T2 A
		<include refid="cmn.pageEnd" />
	</select>

	<!-- 일자별 차량 운행 세부 내역 -->
	<select id="dayCarDrvAnalDtlList" parameterType="map" resultType="box">
		WITH TEMP_RANGE AS (
			SELECT
		          CAST(A.DELIY_DT AS DATE) AS STD_DATE
		        , A.CAR_ID
				, MIN(CASE
				      WHEN C.ZONE_TYPE = '1' THEN C.START_DT
				      WHEN C.ZONE_TYPE = '2' THEN ISNULL(C.ARR_DT, C.START_DT)
					END) AS MIN_DT
				, MAX(CASE
						WHEN C.ZONE_TYPE = '2' AND A.DELIY_DIV = '1' THEN C.ARR_DT
						WHEN C.ZONE_TYPE = '2' AND A.DELIY_DIV = '3' THEN A.DELIY_DT
						WHEN C.ZONE_TYPE = '2'
							THEN
								CASE
									WHEN C.ARR_DT > A.DELIY_DT THEN C.ARR_DT
									ELSE A.DELIY_DT
								END
					  END) AS MAX_DT
			FROM TB_DELI A WITH(NOLOCK)
			INNER JOIN TB_CAR_ZONE_IO C WITH(NOLOCK)
				ON C.SHIP_NO = A.SHIP_NO
			WHERE 1 = 1
			AND EXISTS (
			    SELECT 1
			    FROM TB_DELI_DTL BB WITH (NOLOCK)
				WHERE 1 = 1
				AND BB.BIZ_CD = #{bizCd}
				AND BB.SHIP_NO = A.SHIP_NO
			)
			AND C.CAR_ID = #{carId}
			AND DATEDIFF(DAY, CAST(#{stdDate} AS DATE), A.DELIY_DT) = 0
			AND (
				(C.ZONE_TYPE = '1' AND DATEDIFF(DAY, A.DELIY_DT, C.START_DT) = 0)
				OR (C.ZONE_TYPE IN ('2') AND DATEDIFF(DAY, A.DELIY_DT, C.ARR_DT) = 0)
			)
		    GROUP BY CAST(A.DELIY_DT AS DATE), A.CAR_ID, A.SHIP_NO
		)
		, T1 AS (
			SELECT DISTINCT
				  A.SEQ
				, CONVERT(VARCHAR, A.DEV_DT, 108) AS DEV_TM
				, A.JIBUN_ADDR
				, A.SPD
				, CASE
					WHEN ISNULL(A.DAY_TOT_DIS, 0) = 0 THEN ''
					WHEN A.DAY_TOT_DIS &lt; 1000 THEN CONCAT(A.DAY_TOT_DIS, 'm')
					ELSE CONCAT(CAST(A.DAY_TOT_DIS / 1000.0 AS NUMERIC(10, 1)), 'km')
				  END AS DAY_TOT_DIS
				, IIF(B.CH_CNT &lt; 1, NULL, CAST(A.CH1 / 10.0 AS NUMERIC(4, 1))) AS CH1
				, IIF(B.CH_CNT &lt; 2, NULL, CAST(A.CH2 / 10.0 AS NUMERIC(4, 1))) AS CH2
				, IIF(B.CH_CNT &lt; 3, NULL, CAST(A.CH3 / 10.0 AS NUMERIC(4, 1))) AS CH3
				, IIF(B.CH_CNT &lt; 4, NULL, CAST(A.CH4 / 10.0 AS NUMERIC(4, 1))) AS CH4
				, CASE
				    WHEN C1.ZONE_TYPE = '1' THEN C1.SHIP_NO
				    WHEN C2.ZONE_TYPE = '2' THEN C2.SHIP_NO
				    WHEN C2.ZONE_TYPE = '3' THEN C2.SHIP_NO
				    WHEN C3.ZONE_TYPE = '2' THEN C3.SHIP_NO
				  END AS SHIP_NO
				, CASE
				    WHEN C2.ZONE_TYPE = '2' THEN C2.DELI_NO
				    WHEN C3.ZONE_TYPE = '2' THEN C3.DELI_NO
				  END AS DELI_NO
				, CASE
				    WHEN C2.ZONE_TYPE = '2' THEN C2.AGENT_CD
				    WHEN C3.ZONE_TYPE = '2' THEN C3.AGENT_CD
				  END AS AGENT_CD
				, CASE
				    WHEN C2.ZONE_TYPE = '2' THEN E1.AGENT_NM
				    WHEN C3.ZONE_TYPE = '2' THEN E2.AGENT_NM
				   END AS AGENT_NM
				, CASE C2.AGENT_DELAY_YN
					WHEN 'Y' THEN CASE
									WHEN C2.AGENT_GAP_SEC > 0 THEN CONCAT('지연(+', IIF(C2.AGENT_GAP_SEC &lt; 60, CONCAT(C2.AGENT_GAP_SEC, '초)'),  CONCAT(C2.AGENT_GAP_SEC / 60, '분)')))
									WHEN C2.AGENT_GAP_SEC &lt; 0 THEN CONCAT('지연(', IIF(C2.AGENT_GAP_SEC &lt; -60, CONCAT(C2.AGENT_GAP_SEC, '초)'),  CONCAT(C2.AGENT_GAP_SEC / 60, '분)')))
								  END
					WHEN 'N' THEN '정상'
				  END AS DELAY_TXT
				, F1.CD_NM AS ARR_VIO_NM
				, CASE
 					<!-- WHEN D1.CAR_ID IS NULL THEN '정상' -->
					WHEN D1.VIO_CNT > 0 THEN '이상'
 				  END AS VIO_TXT
				, CASE
 					<!-- WHEN D1.CAR_ID IS NULL THEN '정상' -->
					WHEN D1.VIO_LONG_CNT > 0 THEN '위반'
 				  END AS VIO_LONG_TXT
				, F2.CD_NM AS TEMP_VIO_NM
				, CASE
					WHEN C1.ZONE_TYPE = '1' THEN CONCAT('센터출발',  (SELECT IIF(AA.CENTER_RDY_DT IS NOT NULL, CONCAT('(', CONVERT(VARCHAR(8), AA.CENTER_RDY_DT, 108), ')'), '') FROM TB_DELI AA WHERE AA.SHIP_NO = C1.SHIP_NO))
					WHEN C3.ZONE_TYPE = '2' THEN CONCAT(E2.AGENT_NM, ' 출발')
					WHEN C2.ZONE_TYPE = '2' THEN CONCAT(E1.AGENT_NM, ' 도착')
					WHEN C2.ZONE_TYPE = '3' THEN '센터도착'
				  END AS EVENT
				, ISNULL(C1.ZONE_TYPE, C2.ZONE_TYPE) AS ZONE_TYPE
				, C2.DELAY_YN
				, A.ARR_VIO_CD
				, A.TEMP_VIO_CD
				, A.VIO_DESC
				, C2.AGENT_DELAY_YN
			FROM TB_CAR_HIST A WITH(NOLOCK)
			INNER JOIN TB_CAR B WITH(NOLOCK)
				ON B.CAR_ID = A.CAR_ID
			LEFT OUTER JOIN TB_CAR_ZONE_IO C1 WITH(NOLOCK)
				ON C1.CAR_ID = A.CAR_ID
				AND C1.START_DT = A.DEV_DT
				AND C1.ZONE_TYPE = '1'
			LEFT OUTER JOIN TB_CAR_ZONE_IO C2 WITH(NOLOCK)
				ON C2.CAR_ID = A.CAR_ID
				AND C2.ARR_DT = A.DEV_DT
				AND C2.ZONE_TYPE IN ('2', '3')
			LEFT OUTER JOIN TB_CAR_ZONE_IO C3 WITH(NOLOCK)
				ON C3.CAR_ID = A.CAR_ID
				AND C3.START_DT = A.DEV_DT
				AND C3.ZONE_TYPE = '2'
			LEFT OUTER JOIN TB_CAR_TEMP_VIO D1 WITH(NOLOCK)
				ON D1.CAR_ID = A.CAR_ID
				AND D1.DEV_DT = A.DEV_DT
				AND D1.EVT_FLAG = '1'
			LEFT OUTER JOIN TB_AGENT E1 WITH(NOLOCK)
				ON E1.AGENT_CD = C2.AGENT_CD
			LEFT OUTER JOIN TB_AGENT E2 WITH(NOLOCK)
				ON E2.AGENT_CD = C3.AGENT_CD
			LEFT OUTER JOIN TB_CD F1
				ON F1.GRP_CD = 'VIO_CD'
				AND F1.ETC1 = 'ARR'
				AND F1.CD = A.ARR_VIO_CD
			LEFT OUTER JOIN TB_CD F2
				ON F2.GRP_CD = 'VIO_CD'
				AND F2.ETC1 = 'CAR_TEMP'
				AND F2.CD = A.TEMP_VIO_CD
			<if test='srchDtlDiv != null and srchDtlDiv == "1"'>
				INNER JOIN (
					SELECT
						  MIN(CASE
							  WHEN AA.ZONE_TYPE = '1' THEN AA.START_DT
							  WHEN AA.ZONE_TYPE = '2' THEN ISNULL(AA.ARR_DT, AA.START_DT)
							END) AS MIN_DT
						, MAX(CASE
								WHEN AA.ZONE_TYPE = '2' THEN CASE
																WHEN AA.ARR_DT IS NOT NULL AND AA.START_DT IS NOT NULL THEN IIF(AA.ARR_DT > AA.START_DT, AA.ARR_DT, AA.START_DT)
																ELSE ISNULL(AA.ARR_DT, AA.START_DT)
															END
								WHEN AA.ZONE_TYPE = '3' THEN AA.ARR_DT
							  END) AS MAX_DT
					FROM TB_CAR_ZONE_IO AA WITH(NOLOCK)
					INNER JOIN TB_DELI BB WITH(NOLOCK)
						ON BB.SHIP_NO = AA.SHIP_NO
					WHERE 1 = 1
					AND AA.CAR_ID = #{carId}
					AND DATEDIFF(DAY, CAST(#{stdDate} AS DATE), BB.DELIY_DT) = 0
					AND (
						(AA.ZONE_TYPE = '1' AND DATEDIFF(DAY, BB.DELIY_DT, AA.START_DT) = 0)
						OR (AA.ZONE_TYPE IN ('2', '3') AND DATEDIFF(DAY, BB.DELIY_DT, AA.ARR_DT) = 0)
					)
				) G
					ON G.MIN_DT &lt;= A.DEV_DT
					AND G.MAX_DT >= A.DEV_DT
			</if>
			WHERE A.LOG_DIV IN ('D')
			AND DATEDIFF(DAY, A.DEV_DT, CAST(#{stdDate} AS DATE)) = 0
			AND A.CAR_ID = #{carId}
			<if test='srchDtlDiv != null and srchDtlDiv == "2"'>
				AND (
					ISNULL(C1.ZONE_TYPE, C2.ZONE_TYPE) IS NOT NULL
					OR C3.ZONE_TYPE IS NOT NULL
				)
			</if>
			<if test='srchDtlDiv != null and srchDtlDiv == "3"'>
				AND (
					C2.AGENT_DELAY_YN = 'Y'
					OR EXISTS (
						SELECT 1
						FROM TEMP_RANGE Z
						WHERE Z.CAR_ID = A.CAR_ID
						AND Z.MIN_DT &lt;= A.DEV_DT
						AND Z.MAX_DT >= A.DEV_DT
						AND DATEDIFF(DAY, Z.STD_DATE, Z.MIN_DT) = 0
						AND DATEDIFF(DAY, Z.STD_DATE, Z.MAX_DT) = 0
					)
				)
			</if>
		)
		SELECT
			  ROW_NUMBER() OVER(ORDER BY T1.DEV_TM) AS RNUM
			, T1.*
		FROM T1
	</select>

	<!-- 차량 대리점 도착 위반 / 온도 이상 사유 수정 -->
	<update id="carVioInputUpdate" parameterType="map">
		UPDATE TB_CAR_HIST
			<set>
				<choose>
					<when test='arrVioCd != null and arrVioCd != ""'>
						ARR_VIO_CD = #{arrVioCd},
					</when>
					<otherwise>
						ARR_VIO_CD = NULL,
					</otherwise>
				</choose>

				<choose>
					<when test='tempVioCd != null and tempVioCd != ""'>
						TEMP_VIO_CD = #{tempVioCd},
					</when>
					<otherwise>
						TEMP_VIO_CD = NULL,
					</otherwise>
				</choose>

				<choose>
					<when test='vioDesc != null and vioDesc != ""'>
						VIO_DESC = #{vioDesc},
					</when>
					<otherwise>
						VIO_DESC = NULL,
					</otherwise>
				</choose>
				UPDATE_DT = GETDATE(),
				UPDATE_ID = #{sBox.userId}
			</set>
		WHERE SEQ = ${seq}
	</update>

	<!-- 일자별창고온도 내역 -->
	<select id="dayCargoTempAnalList" parameterType="map" resultType="box">
		SELECT
		<choose>
			<when test='sortColumn != null and sortColumn != ""'>
				ROW_NUMBER() OVER(ORDER BY ${sortColumn} ${sortOrder}) AS RNUM
			</when>
			<otherwise>
				ROW_NUMBER() OVER(ORDER BY A.STD_DATE, B.CENTER_NM, C.CARGO_NM) AS RNUM
			</otherwise>
		</choose>
			, A.STD_DATE
			, B.CENTER_NM
			, C.CARGO_NM
			, C.DEV_ID
			, A.TOT_CNT
			, A.VIO_CNT
			, A.VIO_LONG_CNT
			, CAST(A.NOR_RT AS NUMERIC(4, 1)) AS NOR_RT
			, C.CH_CNT
			, C.CH1_NM
			, C.CH2_NM
			, C.CH3_NM
			, C.CH4_NM
			, C.CH5_NM
			, C.CH6_NM
		FROM TB_CARGO_STAT A
		INNER JOIN TB_CENTER B
			ON B.CENTER_CD = A.CENTER_CD
		INNER JOIN TB_CARGO_DEV C
			ON C.DEV_ID = A.DEV_ID
		WHERE A.CENTER_CD IS NOT NULL
		AND A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
		<if test='!srchCenterCdList.isEmpty and srchCenterCdList.size != 0'>
			<foreach item="item" collection="srchCenterCdList" open="AND (" separator=", A.CENTER_CD) > 0 OR " close=", A.CENTER_CD) > 0)">
				CHARINDEX(#{item.key}
			</foreach>
		</if>
		<if test='srchWord != null and srchWord != ""'>
			<if test='srchMethod == "cargoNm"'>
				AND C.CARGO_NM LIKE '%' + #{srchWord} + '%'
			</if>
		</if>
	</select>

	<!-- 일자별창고온도 세부내역 -->
	<select id="dayCargoTempAnalDtlList" parameterType="map" resultType="box">
		SELECT
		<choose>
			<when test='sortColumn != null and sortColumn != ""'>
				ROW_NUMBER() OVER(ORDER BY ${sortColumn} ${sortOrder}) AS RNUM
			</when>
			<otherwise>
				ROW_NUMBER() OVER(ORDER BY A.DEV_DT) AS RNUM
			</otherwise>
		</choose>
			, A.SEQ
			, A.DEV_DT
			, IIF(B.CH_CNT &lt; 1, NULL, CAST(A.CH1 / 10.0 AS NUMERIC(4, 1))) AS CH1
			, IIF(B.CH_CNT &lt; 2, NULL, CAST(A.CH2 / 10.0 AS NUMERIC(4, 1))) AS CH2
			, IIF(B.CH_CNT &lt; 3, NULL, CAST(A.CH3 / 10.0 AS NUMERIC(4, 1))) AS CH3
			, IIF(B.CH_CNT &lt; 4, NULL, CAST(A.CH4 / 10.0 AS NUMERIC(4, 1))) AS CH4
			, IIF(B.CH_CNT &lt; 5, NULL, CAST(A.CH5 / 10.0 AS NUMERIC(4, 1))) AS CH5
			, IIF(B.CH_CNT &lt; 6, NULL, CAST(A.CH6 / 10.0 AS NUMERIC(4, 1))) AS CH6
			, A.TEMP_VIO_CD
			, A.VIO_DESC
			, CASE
				WHEN C1.DEV_ID IS NULL AND C2.DEV_ID IS NULL THEN '정상'
				ELSE
					CONCAT(
						CASE
							WHEN C1.VIO_LONG_CNT > 0 THEN '기준위반'
							WHEN C1.VIO_CNT > 0 THEN '기준이상'
						END,
						IIF(
							(C1.VIO_LONG_CNT > 0 OR C1.VIO_CNT > 0) AND (C2.VIO_LONG_CNT > 0 OR C2.VIO_CNT > 0),
							'&lt;br&gt;',
							''
						),
						CASE
							WHEN C2.VIO_LONG_CNT > 0 THEN 'HACCP위반'
							WHEN C2.VIO_CNT > 0 THEN 'HACCP이상'
						END
					)
				END AS TEMP_STAT
			, D.CD_NM AS TEMP_VIO_NM
		FROM TB_CARGO_HIST A WITH(NOLOCK)
		INNER JOIN TB_CARGO_DEV B WITH(NOLOCK)
			ON B.DEV_ID = A.DEV_ID
		LEFT OUTER JOIN TB_CARGO_TEMP_VIO C1 WITH(NOLOCK)
			ON C1.DEV_ID = A.DEV_ID
			AND C1.DEV_DT = A.DEV_DT
			AND C1.EVT_FLAG = '1'
		LEFT OUTER JOIN TB_CARGO_TEMP_VIO C2 WITH(NOLOCK)
			ON C2.DEV_ID = A.DEV_ID
			AND C2.DEV_DT = A.DEV_DT
			AND C2.EVT_FLAG = '2'
		LEFT OUTER JOIN TB_CD D
			ON D.GRP_CD = 'VIO_CD'
			AND D.ETC1 = 'CARGO_TEMP'
			AND D.CD = A.TEMP_VIO_CD
		WHERE DATEDIFF(DAY, A.DEV_DT, CAST(#{stdDate} AS DATE)) = 0
		AND A.DEV_ID = #{devId}
	</select>

	<!-- 차량 대리점 도착 위반 / 온도 이상 사유 수정 -->
	<update id="cargoVioInputUpdate" parameterType="map">
		UPDATE TB_CARGO_HIST
			<set>
				<choose>
					<when test='tempVioCd != null and tempVioCd != ""'>
						TEMP_VIO_CD = #{tempVioCd},
					</when>
					<otherwise>
						TEMP_VIO_CD = NULL,
					</otherwise>
				</choose>

				<choose>
					<when test='vioDesc != null and vioDesc != ""'>
						VIO_DESC = #{vioDesc},
					</when>
					<otherwise>
						VIO_DESC = NULL,
					</otherwise>
				</choose>
				UPDATE_DT = GETDATE(),
				UPDATE_ID = #{sBox.userId}
			</set>
		WHERE SEQ = ${seq}
	</update>

	<sql id="dayAnalSearch">
		<if test='!srchCenterCdList.isEmpty and srchCenterCdList.size != 0'>
			<foreach item="item" collection="srchCenterCdList" open="AND (" separator=", A.CENTER_CD) > 0 OR " close=", A.CENTER_CD) > 0)">
				CHARINDEX(#{item.key}
			</foreach>
		</if>
	</sql>

	<!-- 일자별누적내역현황 -->
	<select id="dayAnalList" parameterType="map" resultType="box">
		WITH T1 AS (
			SELECT
				1 AS RN
				, CONCAT('DAY', 1) AS RN_NM
				, CAST(#{srchStrDt} AS DATE) AS DT
			UNION ALL
			SELECT
				RN + 1
				, CONCAT('DAY', RN + 1)
				, DATEADD(DAY, 1, DT) AS DT
			FROM T1
			WHERE DT &lt; CAST(#{srchEndDt} AS DATE)
		),
		T2 AS (
		<if test='srchDayAnalDiv != null and srchDayAnalDiv !=""'>
			<if test='srchDayAnalDiv == "ARR"'>
				SELECT
					  A.STD_DATE
					, A.CENTER_CD
					, MAX(A.WEEKEND_YN) AS WEEKEND_YN
					, SUM(A.ARR_TOT_CNT) AS TOT_CNT
				<choose>
					<when test='srchCarAnalDiv != null and srchCarAnalDiv != "" and srchCarAnalDiv == "AGENT"' >
						, SUM(A.ARR_AGENT_NOR_CNT) AS CNT
						, IIF(SUM(A.ARR_TOT_CNT) = 0, 0, SUM(A.ARR_AGENT_NOR_CNT) * 100.0 / SUM(A.ARR_TOT_CNT)) AS RT
					</when>
					<otherwise>
						, SUM(A.ARR_NOR_CNT) AS CNT
						, IIF(SUM(A.ARR_TOT_CNT) = 0, 0, SUM(A.ARR_NOR_CNT) * 100.0 / SUM(A.ARR_TOT_CNT)) AS RT
					</otherwise>
				</choose>

				FROM TB_CAR_STAT A WITH(NOLOCk)
				WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
				AND A.BIZ_CD = #{srchBizCd}
				AND A.REST_CD = 'N'
				AND A.CENTER_CD IS NOT NULL
				<include refid="dayAnalSearch"/>
				GROUP BY A.STD_DATE, A.CENTER_CD
			</if>
			<if test='srchDayAnalDiv == "TEMP"'>
				SELECT
					  A.STD_DATE
					, A.CENTER_CD
					, MAX(A.WEEKEND_YN) AS WEEKEND_YN
					, SUM(A.TEMP_TOT_CNT) AS TOT_CNT

				<choose>
					<when test='srchCarAnalDiv != null and srchCarAnalDiv != "" and srchCarAnalDiv == "HACCP"' >
						, SUM(A.TEMP_HACCP_NOR_CNT) AS CNT
						, IIF(SUM(A.TEMP_TOT_CNT) = 0, 0, SUM(A.TEMP_HACCP_NOR_CNT) * 100.0 / SUM(A.TEMP_TOT_CNT)) AS RT
					</when>
					<otherwise>
						, SUM(A.TEMP_NOR_CNT) AS CNT
						, IIF(SUM(A.TEMP_TOT_CNT) = 0, 0, SUM(A.TEMP_NOR_CNT) * 100.0 / SUM(A.TEMP_TOT_CNT)) AS RT
					</otherwise>
				</choose>

				FROM TB_CAR_STAT A WITH(NOLOCk)
				WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
				AND A.BIZ_CD = #{srchBizCd}
				AND A.REST_CD = 'N'
				AND A.CENTER_CD IS NOT NULL
				<include refid="dayAnalSearch"/>
				GROUP BY A.STD_DATE, A.CENTER_CD
			</if>
			<if test='srchDayAnalDiv == "CARGO"'>
				SELECT
					  A.STD_DATE
					, A.CENTER_CD
					, MAX(A.WEEKEND_YN) AS WEEKEND_YN
					, SUM(A.TOT_CNT) AS TOT_CNT
					, SUM(A.NOR_CNT) AS CNT
					, IIF(SUM(A.TOT_CNT) = 0, 0, SUM(A.NOR_CNT) * 100.0 / SUM(A.TOT_CNT)) AS RT
				FROM TB_CARGO_STAT A WITH(NOLOCk)
				WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
				AND A.CENTER_CD IS NOT NULL
				<include refid="dayAnalSearch"/>
				GROUP BY A.STD_DATE, A.CENTER_CD
			</if>
			<if test='srchDayAnalDiv == "CARGO_NM"'>
				SELECT
					  A.STD_DATE
					, A.CENTER_CD
					, B.CARGO_NM
					, MAX(A.WEEKEND_YN) AS WEEKEND_YN
					, SUM(A.TOT_CNT) AS TOT_CNT
					, SUM(A.NOR_CNT) AS CNT
					, IIF(SUM(A.TOT_CNT) = 0, 0, SUM(A.NOR_CNT) * 100.0 / SUM(A.TOT_CNT)) AS RT
				FROM TB_CARGO_STAT A WITH(NOLOCk)
				INNER JOIN TB_CARGO_DEV B WITH(NOLOCK)
					ON B.DEV_ID = A.DEV_ID
					AND B.CENTER_CD = A.CENTER_CD
					AND B.USE_YN = 'Y'
					AND B.CENTER_CD IS NOT NULL
				WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
				AND A.CENTER_CD IS NOT NULL
				<include refid="dayAnalSearch"/>
				GROUP BY A.STD_DATE, A.CENTER_CD, B.CARGO_NM
			</if>
		</if>
		),
		T3 AS (
			<choose>
				<when test='srchDayAnalDiv == "CARGO_NM"'>
					SELECT
						 A.RN_NM
						,B.RT
						,B.CENTER_CD
						,C.CENTER_NM
						,B.CARGO_NM
						,B.TOT_CNT
						,B.CNT
						,MAX(B.RT) OVER(PARTITION BY B.CENTER_CD, B.CARGO_NM) AS MAX_RT
						,MIN(B.RT) OVER(PARTITION BY B.CENTER_CD, B.CARGO_NM) AS MIN_RT
						,SUM(CASE WHEN B.WEEKEND_YN = 'Y' THEN IIF(B.CNT IS NULL, 0, B.CNT) ELSE 0 END) OVER(PARTITION BY B.CENTER_CD, B.CARGO_NM) AS WEEKEND_CNT
						,SUM(CASE WHEN B.WEEKEND_YN = 'Y' THEN B.TOT_CNT ELSE 0 END) OVER(PARTITION BY B.CENTER_CD, B.CARGO_NM) AS TOT_WEEKEND_CNT
						,SUM(CASE WHEN B.WEEKEND_YN = 'N' THEN IIF(B.CNT IS NULL, 0, B.CNT) ELSE 0 END) OVER(PARTITION BY B.CENTER_CD, B.CARGO_NM) AS NOR_CNT
						,SUM(CASE WHEN B.WEEKEND_YN = 'N' THEN B.TOT_CNT ELSE 0 END) OVER(PARTITION BY B.CENTER_CD, B.CARGO_NM) AS TOT_NOR_CNT
						,B.STD_DATE
					FROM T1 A
					LEFT OUTER JOIN T2 B
						ON B.STD_DATE = A.DT
					INNER JOIN TB_CENTER C WITH(NOLOCk)
						ON C.CENTER_CD = B.CENTER_CD
				</when>
				<otherwise>
					SELECT
						 A.RN_NM
						,B.RT
						,C.CENTER_CD
						,C.CENTER_NM
						,B.TOT_CNT
						,B.CNT
						,MAX(B.RT) OVER(PARTITION BY B.CENTER_CD) AS MAX_RT
						,MIN(B.RT) OVER(PARTITION BY B.CENTER_CD) AS MIN_RT
						,SUM(CASE WHEN B.WEEKEND_YN = 'Y' THEN IIF(B.CNT IS NULL, 0, B.CNT) ELSE 0 END) OVER(PARTITION BY B.CENTER_CD) AS WEEKEND_CNT
						,SUM(CASE WHEN B.WEEKEND_YN = 'Y' THEN B.TOT_CNT ELSE 0 END) OVER(PARTITION BY B.CENTER_CD) AS TOT_WEEKEND_CNT
						,SUM(CASE WHEN B.WEEKEND_YN = 'N' THEN IIF(B.CNT IS NULL, 0, B.CNT) ELSE 0 END) OVER(PARTITION BY B.CENTER_CD) AS NOR_CNT
						,SUM(CASE WHEN B.WEEKEND_YN = 'N' THEN B.TOT_CNT ELSE 0 END) OVER(PARTITION BY B.CENTER_CD) AS TOT_NOR_CNT
						,B.STD_DATE
					FROM T1 A
					LEFT OUTER JOIN T2 B
						ON B.STD_DATE = A.DT
					INNER JOIN TB_CENTER C WITH(NOLOCk)
						ON C.CENTER_CD = B.CENTER_CD
				</otherwise>
			</choose>
		),
		T4 AS (
			SELECT *
			FROM T3
			PIVOT (
				MAX(RT)
				FOR RN_NM IN (
					DAY1, DAY2, DAY3, DAY4, DAY5, DAY6, DAY7, DAY8, DAY9, DAY10,
					DAY11, DAY12, DAY13, DAY14, DAY15, DAY16, DAY17, DAY18, DAY19, DAY20,
					DAY21, DAY22, DAY23, DAY24, DAY25, DAY26, DAY27, DAY28, DAY29, DAY30,
					DAY31
				)
			) A
		)
		SELECT
			 CENTER_CD
			,CENTER_NM
		<if test='srchDayAnalDiv == "CARGO_NM"'>
			,CARGO_NM
		</if>
			,IIF(SUM(TOT_CNT) = 0, 0, CAST(SUM(CNT) * 100.0 / SUM(TOT_CNT) AS NUMERIC(4, 1))) AS TOT_RT
			,CAST(MAX(MAX_RT) AS NUMERIC(4, 1)) AS MAX_RT
			,CAST(MIN(MIN_RT) AS NUMERIC(4, 1)) AS MIN_RT
			,IIF(MAX(TOT_NOR_CNT) = 0, 0, CAST(MAX(NOR_CNT) * 100.0 / MAX(TOT_NOR_CNT) AS NUMERIC(4, 1))) AS NORMAL_RT
			,IIF(MAX(TOT_WEEKEND_CNT) = 0, 0, CAST(MAX(WEEKEND_CNT) * 100.0 / MAX(TOT_WEEKEND_CNT) AS NUMERIC(4, 1))) AS WEEKEND_RT
			,CAST(MAX(DAY1) AS NUMERIC(4, 1)) AS DAY1
			,CAST(MAX(DAY2) AS NUMERIC(4, 1)) AS DAY2
			,CAST(MAX(DAY3) AS NUMERIC(4, 1)) AS DAY3
			,CAST(MAX(DAY4) AS NUMERIC(4, 1)) AS DAY4
			,CAST(MAX(DAY5) AS NUMERIC(4, 1)) AS DAY5
			,CAST(MAX(DAY6) AS NUMERIC(4, 1)) AS DAY6
			,CAST(MAX(DAY7) AS NUMERIC(4, 1)) AS DAY7
			,CAST(MAX(DAY8) AS NUMERIC(4, 1)) AS DAY8
			,CAST(MAX(DAY9) AS NUMERIC(4, 1)) AS DAY9
			,CAST(MAX(DAY10) AS NUMERIC(4, 1)) AS DAY10
			,CAST(MAX(DAY11) AS NUMERIC(4, 1)) AS DAY11
			,CAST(MAX(DAY12) AS NUMERIC(4, 1)) AS DAY12
			,CAST(MAX(DAY13) AS NUMERIC(4, 1)) AS DAY13
			,CAST(MAX(DAY14) AS NUMERIC(4, 1)) AS DAY14
			,CAST(MAX(DAY15) AS NUMERIC(4, 1)) AS DAY15
			,CAST(MAX(DAY16) AS NUMERIC(4, 1)) AS DAY16
			,CAST(MAX(DAY17) AS NUMERIC(4, 1)) AS DAY17
			,CAST(MAX(DAY18) AS NUMERIC(4, 1)) AS DAY18
			,CAST(MAX(DAY19) AS NUMERIC(4, 1)) AS DAY19
			,CAST(MAX(DAY20) AS NUMERIC(4, 1)) AS DAY20
			,CAST(MAX(DAY21) AS NUMERIC(4, 1)) AS DAY21
			,CAST(MAX(DAY22) AS NUMERIC(4, 1)) AS DAY22
			,CAST(MAX(DAY23) AS NUMERIC(4, 1)) AS DAY23
			,CAST(MAX(DAY24) AS NUMERIC(4, 1)) AS DAY24
			,CAST(MAX(DAY25) AS NUMERIC(4, 1)) AS DAY25
			,CAST(MAX(DAY26) AS NUMERIC(4, 1)) AS DAY26
			,CAST(MAX(DAY27) AS NUMERIC(4, 1)) AS DAY27
			,CAST(MAX(DAY28) AS NUMERIC(4, 1)) AS DAY28
			,CAST(MAX(DAY29) AS NUMERIC(4, 1)) AS DAY29
			,CAST(MAX(DAY30) AS NUMERIC(4, 1)) AS DAY30
			,CAST(MAX(DAY31) AS NUMERIC(4, 1)) AS DAY31
		FROM T4
		<choose>
			<when test='srchDayAnalDiv == "CARGO_NM"'>
				GROUP BY CENTER_CD, CENTER_NM, CARGO_NM
			</when>
			<otherwise>
				GROUP BY CENTER_CD, CENTER_NM
			</otherwise>
		</choose>
	</select>

	<select id="dayAnalSum" parameterType="map" resultType="box">
		WITH T1 AS (
			SELECT
				1 AS RN
				, CONCAT('DAY', 1) AS RN_NM
				, CAST(#{srchStrDt} AS DATE) AS DT
			UNION ALL
			SELECT
				RN + 1
				, CONCAT('DAY', RN + 1)
				, DATEADD(DAY, 1, DT) AS DT
			FROM T1
			WHERE DT &lt; CAST(#{srchEndDt} AS DATE)
		)
		, T2 AS (
		<if test='srchDayAnalDiv != null and srchDayAnalDiv !=""'>
			<if test='srchDayAnalDiv == "ARR"'>
				SELECT
					  A.STD_DATE
				<choose>
					<when test='srchCarAnalDiv == "AGENT"' >
						, IIF(SUM(A.ARR_TOT_CNT) = 0, 0, CAST(SUM(A.ARR_AGENT_NOR_CNT) * 100.0 / SUM(A.ARR_TOT_CNT) AS NUMERIC(4, 1))) AS RT
					</when>
					<otherwise>
						, IIF(SUM(A.ARR_TOT_CNT) = 0, 0, CAST(SUM(A.ARR_NOR_CNT) * 100.0 / SUM(A.ARR_TOT_CNT) AS NUMERIC(4, 1))) AS RT
					</otherwise>
				</choose>
				FROM TB_CAR_STAT A WITH(NOLOCk)
				WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
				AND A.BIZ_CD = #{srchBizCd}
				AND A.REST_CD = 'N'
				AND A.CENTER_CD IS NOT NULL
				<include refid="dayAnalSearch"/>
				GROUP BY A.STD_DATE
			</if>
			<if test='srchDayAnalDiv == "TEMP"'>
				SELECT
					  A.STD_DATE
				<choose>
					<when test='srchCarAnalDiv == "HACCP"' >
						, IIF(SUM(A.TEMP_TOT_CNT) = 0, 0, CAST(SUM(A.TEMP_HACCP_NOR_CNT) * 100.0 / SUM(A.TEMP_TOT_CNT) AS NUMERIC(4, 1))) AS RT
					</when>
					<otherwise>
						, IIF(SUM(A.TEMP_TOT_CNT) = 0, 0, CAST(SUM(A.TEMP_NOR_CNT) * 100.0 / SUM(A.TEMP_TOT_CNT) AS NUMERIC(4, 1))) AS RT
					</otherwise>
				</choose>
				FROM TB_CAR_STAT A WITH(NOLOCk)
				WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
				AND A.BIZ_CD = #{srchBizCd}
				AND A.REST_CD = 'N'
				AND A.CENTER_CD IS NOT NULL
				<include refid="dayAnalSearch"/>
				GROUP BY A.STD_DATE
			</if>
			<if test='srchDayAnalDiv == "CARGO" or srchDayAnalDiv == "CARGO_NM"'>
				SELECT
					  A.STD_DATE
					, IIF(SUM(A.TOT_CNT) = 0, 0, CAST(SUM(A.NOR_CNT) * 100.0 / SUM(A.TOT_CNT) AS NUMERIC(4, 1))) AS RT
				FROM TB_CARGO_STAT A WITH(NOLOCk)
				WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
				AND A.CENTER_CD IS NOT NULL
				<include refid="dayAnalSearch"/>
				GROUP BY A.STD_DATE
			</if>
		</if>
		)
		, T3 AS (
			SELECT
				 A.RN_NM
				,B.RT
			FROM T1 A
			LEFT OUTER JOIN T2 B
				ON B.STD_DATE = A.DT
		)
		, T4 AS (
			SELECT *
			FROM T3
			PIVOT (
				MAX(RT)
				FOR RN_NM IN (
					DAY1, DAY2, DAY3, DAY4, DAY5, DAY6, DAY7, DAY8, DAY9, DAY10,
					DAY11, DAY12, DAY13, DAY14, DAY15, DAY16, DAY17, DAY18, DAY19, DAY20,
					DAY21, DAY22, DAY23, DAY24, DAY25, DAY26, DAY27, DAY28, DAY29, DAY30,
					DAY31
				)
			) A
		)
		SELECT
			B.TOT_RT,
			DAY1, DAY2, DAY3, DAY4, DAY5, DAY6, DAY7, DAY8, DAY9, DAY10,
			DAY11, DAY12, DAY13, DAY14, DAY15, DAY16, DAY17, DAY18, DAY19, DAY20,
			DAY21, DAY22, DAY23, DAY24, DAY25, DAY26, DAY27, DAY28, DAY29, DAY30,
			DAY31
		FROM T4
		CROSS APPLY (
		    <if test='srchDayAnalDiv != null and srchDayAnalDiv !=""'>
				<if test='srchDayAnalDiv == "ARR"'>
					SELECT
					<choose>
						<when test='srchCarAnalDiv == "AGENT"' >
							IIF(SUM(A.ARR_TOT_CNT) = 0, 0, CAST(SUM(A.ARR_AGENT_NOR_CNT) * 100.0 / SUM(A.ARR_TOT_CNT) AS NUMERIC(4, 1))) AS TOT_RT
						</when>
						<otherwise>
							IIF(SUM(A.ARR_TOT_CNT) = 0, 0, CAST(SUM(A.ARR_NOR_CNT) * 100.0 / SUM(A.ARR_TOT_CNT) AS NUMERIC(4, 1))) AS TOT_RT
						</otherwise>
					</choose>
					FROM TB_CAR_STAT A WITH(NOLOCk)
					WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
					AND A.BIZ_CD = #{srchBizCd}
					AND A.REST_CD = 'N'
					AND A.CENTER_CD IS NOT NULL
					<include refid="dayAnalSearch"/>
				</if>
				<if test='srchDayAnalDiv == "TEMP"'>
					SELECT
					<choose>
						<when test='srchCarAnalDiv == "HACCP"' >
							IIF(SUM(A.TEMP_TOT_CNT) = 0, 0, CAST(SUM(A.TEMP_HACCP_NOR_CNT) * 100.0 / SUM(A.TEMP_TOT_CNT) AS NUMERIC(4, 1))) AS TOT_RT
						</when>
						<otherwise>
							IIF(SUM(A.TEMP_TOT_CNT) = 0, 0, CAST(SUM(A.TEMP_NOR_CNT) * 100.0 / SUM(A.TEMP_TOT_CNT) AS NUMERIC(4, 1))) AS TOT_RT
						</otherwise>
					</choose>
					FROM TB_CAR_STAT A WITH(NOLOCk)
					WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
					AND A.BIZ_CD = #{srchBizCd}
					AND A.REST_CD = 'N'
					AND A.CENTER_CD IS NOT NULL
					<include refid="dayAnalSearch"/>
				</if>
				<if test='srchDayAnalDiv == "CARGO" or srchDayAnalDiv == "CARGO_NM"'>
					SELECT
						IIF(SUM(A.TOT_CNT) = 0, 0, CAST(SUM(A.NOR_CNT) * 100.0 / SUM(A.TOT_CNT) AS NUMERIC(4, 1))) AS TOT_RT
					FROM TB_CARGO_STAT A WITH(NOLOCk)
					WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
					AND A.CENTER_CD IS NOT NULL
					<include refid="dayAnalSearch"/>
				</if>
			</if>
		) B
	</select>

	<!-- 차량별누적현황 -->
	<select id="carDayAnalList" parameterType="map" resultType="box">
		WITH T1 AS (
			SELECT
				1 AS RN
				, CONCAT('DAY', 1) AS RN_NM
				, CAST(#{srchStrDt} AS DATE) AS DT
			UNION ALL
			SELECT
				RN + 1
				, CONCAT('DAY', RN + 1)
				, DATEADD(DAY, 1, DT) AS DT
			FROM T1
			WHERE DT &lt; CAST(#{srchEndDt} AS DATE)
		),
		T2 AS (
		<if test='srchAnalDiv != null and srchAnalDiv !=""'>
			<if test='srchAnalDiv == "TEMP"'>
				SELECT
					  A.STD_DATE
					, A.CAR_ID
					, A.BIZ_CD
					, A.CENTER_CD
					, A.WEEKEND_YN AS WEEKEND_YN
					, A.TEMP_TOT_CNT AS TOT_CNT
				<choose>
					<when test='srchCarAnalDiv != null and srchCarAnalDiv != "" and srchCarAnalDiv == "HACCP"' >
						, A.TEMP_HACCP_NOR_CNT AS CNT
						, A.TEMP_HACCP_NOR_RT AS RT
					</when>
					<otherwise>
						, A.TEMP_NOR_CNT AS CNT
						, A.TEMP_NOR_RT AS RT
					</otherwise>
				</choose>

				FROM TB_CAR_STAT A
			</if>
			<if test='srchAnalDiv == "ARR"'>
				SELECT
					  A.STD_DATE
					, A.CAR_ID
					, A.BIZ_CD
					, A.CENTER_CD
					, A.WEEKEND_YN AS WEEKEND_YN
					, A.ARR_TOT_CNT AS TOT_CNT
				<choose>
					<when test='srchCarAnalDiv != null and srchCarAnalDiv != "" and srchCarAnalDiv == "AGENT"' >
						, A.ARR_AGENT_NOR_CNT AS CNT
						, A.ARR_AGENT_NOR_RT AS RT
					</when>
					<otherwise>
						, A.ARR_NOR_CNT AS CNT
						, A.ARR_NOR_RT AS RT
					</otherwise>
				</choose>

				FROM TB_CAR_STAT A
			</if>
			<if test='srchAnalDiv == "DELI"'>
				 SELECT
					  A.STD_DATE
					, A.CAR_ID
					, A.BIZ_CD
					, A.CENTER_CD
					, A.WEEKEND_YN
					, A.SHIP_CNT
					, A.DELI_PLAN_CNT
					, A.DELI_COMP_CNT
					, A.DELI_COMP_SHOW
				FROM TB_CAR_STAT A
			</if>
		</if>

			INNER JOIN TB_CAR B WITH(NOLOCK)
				ON A.CAR_ID = B.CAR_ID
				AND B.USE_YN = 'Y'
		    	AND (B.CAR_TID LIKE '012%' OR B.RENT_YN = 'Y')
			    AND B.CAR_NO IS NOT NULL
		<if test='srchCarNo != null and srchCarNo != ""'>
				AND B.CAR_NO LIKE '%' + #{srchCarNo} + '%'
		</if>
			WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
			AND A.BIZ_CD = #{srchBizCd}
		    AND A.REST_CD = 'N'
		<if test='!srchCenterCdList.isEmpty and srchCenterCdList.size != 0'>
			<foreach item="item" collection="srchCenterCdList" open="AND (" separator=", A.CENTER_CD) > 0 OR " close=", A.CENTER_CD) > 0)">
				CHARINDEX(#{item.key}
			</foreach>
		</if>
		),
		T3 AS (
			SELECT
		<if test='srchAnalDiv != null and srchAnalDiv !=""'>
			<if test='srchAnalDiv == "TEMP" or srchAnalDiv == "ARR"'>
				  A.RN_NM
		 		, B.RT
				, B.CAR_ID
				, C.CENTER_CD
				, C.CENTER_NM
		 		, B.TOT_CNT
		 		, B.CNT
		 		, MAX(B.RT) OVER(PARTITION BY B.CAR_ID)                                                                      AS MAX_RT
		 		, MIN(B.RT) OVER(PARTITION BY B.CAR_ID)                                                                      AS MIN_RT
		 		, SUM(CASE WHEN B.WEEKEND_YN = 'Y' THEN IIF(B.CNT IS NULL, 0, B.CNT) ELSE 0 END) OVER(PARTITION BY B.CAR_ID) AS WEEKEND_CNT
		 		, SUM(CASE WHEN B.WEEKEND_YN = 'Y' THEN B.TOT_CNT ELSE 0 END) OVER(PARTITION BY B.CAR_ID)                    AS TOT_WEEKEND_CNT
		 		, SUM(CASE WHEN B.WEEKEND_YN = 'N' THEN IIF(B.CNT IS NULL, 0, B.CNT) ELSE 0 END) OVER(PARTITION BY B.CAR_ID) AS NOR_CNT
		 		, SUM(CASE WHEN B.WEEKEND_YN = 'N' THEN B.TOT_CNT ELSE 0 END) OVER(PARTITION BY B.CAR_ID)                    AS TOT_NOR_CNT
				, B.STD_DATE
			</if>
			<if test='srchAnalDiv == "DELI"'>
				  A.RN_NM
				, B.DELI_COMP_SHOW
				, B.CAR_ID
				, C.CENTER_CD
				, C.CENTER_NM
				, SUM(B.SHIP_CNT) OVER(PARTITION BY B.CAR_ID) AS SHIP_CNT
				, SUM(B.DELI_PLAN_CNT) OVER(PARTITION BY B.CAR_ID) AS DELI_PLAN_CNT
				, SUM(B.DELI_COMP_CNT) OVER(PARTITION BY B.CAR_ID) AS DELI_COMP_CNT
				, B.STD_DATE
			</if>
		</if>
			FROM T1 A
			LEFT OUTER JOIN T2 B
				ON B.STD_DATE = A.DT
			INNER JOIN TB_CENTER C
				ON C.CENTER_CD = B.CENTER_CD
		),
		T4 AS (
			SELECT *
			FROM T3
			PIVOT (
		<if test='srchAnalDiv != null and srchAnalDiv !=""'>
			<if test='srchAnalDiv == "TEMP" or srchAnalDiv == "ARR"'>
				MAX(RT)
			</if>
			<if test='srchAnalDiv == "DELI"'>
				MAX(DELI_COMP_SHOW)
			</if>
		</if>
				FOR RN_NM IN (
					DAY1, DAY2, DAY3, DAY4, DAY5, DAY6, DAY7, DAY8, DAY9, DAY10,
					DAY11, DAY12, DAY13, DAY14, DAY15, DAY16, DAY17, DAY18, DAY19, DAY20,
					DAY21, DAY22, DAY23, DAY24, DAY25, DAY26, DAY27, DAY28, DAY29, DAY30,
					DAY31
				)

			) X
		)
		SELECT
			ROW_NUMBER() OVER(ORDER BY A.CENTER_NM, B.CAR_ID) AS RNUM
			, A.*
			, B.COMPANY_CD
			, C.CD_NM AS COMPANY_NM
			, B.CAR_NO
			, B.DRV_NM
		FROM (
			SELECT
				  CENTER_CD
				, CENTER_NM
				, CAR_ID
		<if test='srchAnalDiv != null and srchAnalDiv !=""'>
			<if test='srchAnalDiv == "TEMP" or srchAnalDiv == "ARR"'>
				, IIF(SUM(TOT_CNT) = 0, 0, CAST(SUM(CNT) * 100.0 / SUM(TOT_CNT) AS NUMERIC(5, 1))) AS TOT_RT
				, CAST(MAX(MAX_RT) AS NUMERIC(5, 1)) AS MAX_RT
				, CAST(MIN(MIN_RT) AS NUMERIC(5, 1)) AS MIN_RT
				, IIF(MAX(TOT_NOR_CNT) = 0, 0, CAST(MAX(NOR_CNT) * 100.0 / MAX(TOT_NOR_CNT) AS NUMERIC(5, 1))) AS NORMAL_RT
				, IIF(MAX(TOT_WEEKEND_CNT) = 0, 0, CAST(MAX(WEEKEND_CNT) * 100.0 / MAX(TOT_WEEKEND_CNT) AS NUMERIC(5, 1))) AS WEEKEND_RT
			</if>
			<if test='srchAnalDiv == "DELI"'>
				, MAX(SHIP_CNT) AS SHIP_CNT
				, MAX(DELI_PLAN_CNT) AS DELI_PLAN_CNT
				, MAX(DELI_COMP_CNT) AS DELI_COMP_CNT
			</if>
		</if>
				, MAX(DAY1) AS DAY1
				, MAX(DAY2) AS DAY2
				, MAX(DAY3) AS DAY3
				, MAX(DAY4) AS DAY4
				, MAX(DAY5) AS DAY5
				, MAX(DAY6) AS DAY6
				, MAX(DAY7) AS DAY7
				, MAX(DAY8) AS DAY8
				, MAX(DAY9) AS DAY9
				, MAX(DAY10) AS DAY10
				, MAX(DAY11) AS DAY11
				, MAX(DAY12) AS DAY12
				, MAX(DAY13) AS DAY13
				, MAX(DAY14) AS DAY14
				, MAX(DAY15) AS DAY15
				, MAX(DAY16) AS DAY16
				, MAX(DAY17) AS DAY17
				, MAX(DAY18) AS DAY18
				, MAX(DAY19) AS DAY19
				, MAX(DAY20) AS DAY20
				, MAX(DAY21) AS DAY21
				, MAX(DAY22) AS DAY22
				, MAX(DAY23) AS DAY23
				, MAX(DAY24) AS DAY24
				, MAX(DAY25) AS DAY25
				, MAX(DAY26) AS DAY26
				, MAX(DAY27) AS DAY27
				, MAX(DAY28) AS DAY28
				, MAX(DAY29) AS DAY29
				, MAX(DAY30) AS DAY30
				, MAX(DAY31) AS DAY31
			FROM T4
			WHERE 1 = 1
			GROUP BY CAR_ID, CENTER_CD, CENTER_NM
		) A
		INNER JOIN TB_CAR B WITH(NOLOCK)
			ON B.CAR_ID = A.CAR_ID
		LEFT OUTER JOIN TB_CD C
			ON C.GRP_CD = 'COMPANY_CD'
			AND C.CD = B.COMPANY_CD
	</select>

	<select id="carDayAnalSum" parameterType="map" resultType="box">
		WITH T1 AS (
			SELECT
				1 AS RN
				, CONCAT('DAY', 1) AS RN_NM
				, CAST(#{srchStrDt} AS DATE) AS DT
			UNION ALL
			SELECT
				RN + 1
				, CONCAT('DAY', RN + 1)
				, DATEADD(DAY, 1, DT) AS DT
			FROM T1
			WHERE DT &lt; CAST(#{srchEndDt} AS DATE)
		),
		T2 AS (
		<if test='srchAnalDiv != null and srchAnalDiv !=""'>
			SELECT
				A.STD_DATE
			<if test='srchAnalDiv == "TEMP"'>
				<choose>
					<when test='srchCarAnalDiv == "HACCP"' >
						, IIF(SUM(A.TEMP_TOT_CNT) = 0, 0, CAST(SUM(A.TEMP_HACCP_NOR_CNT) * 100.0 / SUM(A.TEMP_TOT_CNT) AS NUMERIC(4, 1))) AS VAL
					</when>
					<otherwise>
						, IIF(SUM(A.TEMP_TOT_CNT) = 0, 0, CAST(SUM(A.TEMP_NOR_CNT) * 100.0 / SUM(A.TEMP_TOT_CNT) AS NUMERIC(4, 1))) AS VAL
					</otherwise>
				</choose>
			</if>
			<if test='srchAnalDiv == "ARR"'>
				<choose>
					<when test='srchCarAnalDiv == "AGENT"' >
						, IIF(SUM(A.ARR_TOT_CNT) = 0, 0, CAST(SUM(A.ARR_AGENT_NOR_CNT) * 100.0 / SUM(A.ARR_TOT_CNT) AS NUMERIC(4, 1))) AS VAL
					</when>
					<otherwise>
						, IIF(SUM(A.ARR_TOT_CNT) = 0, 0, CAST(SUM(A.ARR_NOR_CNT) * 100.0 / SUM(A.ARR_TOT_CNT) AS NUMERIC(4, 1))) AS VAL
					</otherwise>
				</choose>
			</if>
			<if test='srchAnalDiv == "DELI"'>
				, CONCAT(ISNULL(SUM(A.DELI_COMP_CNT), '-'), '/', ISNULL(SUM(A.DELI_PLAN_CNT), '-')) AS VAL
			</if>
		</if>
			FROM TB_CAR_STAT A WITH(NOLOCK)
			INNER JOIN TB_CAR B WITH(NOLOCK)
				ON A.CAR_ID = B.CAR_ID
				AND B.USE_YN = 'Y'
				AND (B.CAR_TID LIKE '012%' OR B.RENT_YN = 'Y')
				AND B.CAR_NO IS NOT NULL
		<if test='srchCarNo != null and srchCarNo != ""'>
				AND B.CAR_NO LIKE '%' + #{srchCarNo} + '%'
		</if>
			WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
			AND A.BIZ_CD = #{srchBizCd}
		    AND A.REST_CD = 'N'
		<if test='!srchCenterCdList.isEmpty and srchCenterCdList.size != 0'>
			<foreach item="item" collection="srchCenterCdList" open="AND (" separator=", A.CENTER_CD) > 0 OR " close=", A.CENTER_CD) > 0)">
				CHARINDEX(#{item.key}
			</foreach>
		</if>
			GROUP BY A.STD_DATE
		)
		, T3 AS (
			SELECT
				 A.RN_NM
				,B.VAL
			FROM T1 A
			LEFT OUTER JOIN T2 B
				ON B.STD_DATE = A.DT
		)
		, T4 AS (
			SELECT *
			FROM T3
			PIVOT (
				MAX(VAL)
				FOR RN_NM IN (
					DAY1, DAY2, DAY3, DAY4, DAY5, DAY6, DAY7, DAY8, DAY9, DAY10,
					DAY11, DAY12, DAY13, DAY14, DAY15, DAY16, DAY17, DAY18, DAY19, DAY20,
					DAY21, DAY22, DAY23, DAY24, DAY25, DAY26, DAY27, DAY28, DAY29, DAY30,
					DAY31
				)
			) A
		)
		SELECT
			B.*,
			DAY1, DAY2, DAY3, DAY4, DAY5, DAY6, DAY7, DAY8, DAY9, DAY10,
			DAY11, DAY12, DAY13, DAY14, DAY15, DAY16, DAY17, DAY18, DAY19, DAY20,
			DAY21, DAY22, DAY23, DAY24, DAY25, DAY26, DAY27, DAY28, DAY29, DAY30,
			DAY31
		FROM T4
		CROSS APPLY (
		    <if test='srchAnalDiv != null and srchAnalDiv !=""'>
				SELECT
				<if test='srchAnalDiv == "TEMP"'>
					<choose>
						<when test='srchCarAnalDiv == "HACCP"' >
							IIF(SUM(IIF(A.WEEKEND_YN = 'Y', A.TEMP_TOT_CNT, 0)) = 0, 0, CAST(SUM(IIF(A.WEEKEND_YN = 'Y', A.TEMP_HACCP_NOR_CNT, 0)) * 100.0 / SUM(IIF(A.WEEKEND_YN = 'Y', A.TEMP_TOT_CNT, 0)) AS NUMERIC(4, 1))) AS NORMAL_RT,
	    					IIF(SUM(IIF(A.WEEKEND_YN = 'N', A.TEMP_TOT_CNT, 0)) = 0, 0, CAST(SUM(IIF(A.WEEKEND_YN = 'N', A.TEMP_HACCP_NOR_CNT, 0)) * 100.0 / SUM(IIF(A.WEEKEND_YN = 'N', A.TEMP_TOT_CNT, 0)) AS NUMERIC(4, 1))) AS WEEKEND_RT
						</when>
						<otherwise>
							IIF(SUM(IIF(A.WEEKEND_YN = 'Y', A.TEMP_TOT_CNT, 0)) = 0, 0, CAST(SUM(IIF(A.WEEKEND_YN = 'Y', A.TEMP_NOR_CNT, 0)) * 100.0 / SUM(IIF(A.WEEKEND_YN = 'Y', A.TEMP_TOT_CNT, 0)) AS NUMERIC(4, 1))) AS NORMAL_RT,
	    					IIF(SUM(IIF(A.WEEKEND_YN = 'N', A.TEMP_TOT_CNT, 0)) = 0, 0, CAST(SUM(IIF(A.WEEKEND_YN = 'N', A.TEMP_NOR_CNT, 0)) * 100.0 / SUM(IIF(A.WEEKEND_YN = 'N', A.TEMP_TOT_CNT, 0)) AS NUMERIC(4, 1))) AS WEEKEND_RT
						</otherwise>
					</choose>
				</if>
				<if test='srchAnalDiv == "ARR"'>
					<choose>
						<when test='srchCarAnalDiv == "AGENT"' >
							IIF(SUM(IIF(A.WEEKEND_YN = 'Y', A.ARR_TOT_CNT, 0)) = 0, 0, CAST(SUM(IIF(A.WEEKEND_YN = 'Y', A.ARR_AGENT_NOR_CNT, 0)) * 100.0 / SUM(IIF(A.WEEKEND_YN = 'Y', A.ARR_TOT_CNT, 0)) AS NUMERIC(4, 1))) AS NORMAL_RT,
	    					IIF(SUM(IIF(A.WEEKEND_YN = 'N', A.ARR_TOT_CNT, 0)) = 0, 0, CAST(SUM(IIF(A.WEEKEND_YN = 'N', A.ARR_AGENT_NOR_CNT, 0)) * 100.0 / SUM(IIF(A.WEEKEND_YN = 'N', A.ARR_TOT_CNT, 0)) AS NUMERIC(4, 1))) AS WEEKEND_RT
						</when>
						<otherwise>
							IIF(SUM(IIF(A.WEEKEND_YN = 'Y', A.ARR_TOT_CNT, 0)) = 0, 0, CAST(SUM(IIF(A.WEEKEND_YN = 'Y', A.ARR_NOR_CNT, 0)) * 100.0 / SUM(IIF(A.WEEKEND_YN = 'Y', A.ARR_TOT_CNT, 0)) AS NUMERIC(4, 1))) AS NORMAL_RT,
	    					IIF(SUM(IIF(A.WEEKEND_YN = 'N', A.ARR_TOT_CNT, 0)) = 0, 0, CAST(SUM(IIF(A.WEEKEND_YN = 'N', A.ARR_NOR_CNT, 0)) * 100.0 / SUM(IIF(A.WEEKEND_YN = 'N', A.ARR_TOT_CNT, 0)) AS NUMERIC(4, 1))) AS WEEKEND_RT
						</otherwise>
					</choose>
				</if>
				<if test='srchAnalDiv == "DELI"'>
					SUM(A.SHIP_CNT) AS SHIP_CNT,
					SUM(A.DELI_PLAN_CNT) AS DELI_PLAN_CNT,
					SUM(A.DELI_COMP_CNT) AS DELI_COMP_CNT
				</if>
			</if>
				FROM TB_CAR_STAT A WITH(NOLOCK)
				INNER JOIN TB_CAR B WITH(NOLOCK)
					ON A.CAR_ID = B.CAR_ID
					AND B.USE_YN = 'Y'
					AND (B.CAR_TID LIKE '012%' OR B.RENT_YN = 'Y')
					AND B.CAR_NO IS NOT NULL
			<if test='srchCarNo != null and srchCarNo != ""'>
					AND B.CAR_NO LIKE '%' + #{srchCarNo} + '%'
			</if>
				WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
				AND A.BIZ_CD = #{srchBizCd}
				AND A.REST_CD = 'N'
			<if test='!srchCenterCdList.isEmpty and srchCenterCdList.size != 0'>
				<foreach item="item" collection="srchCenterCdList" open="AND (" separator=", A.CENTER_CD) > 0 OR " close=", A.CENTER_CD) > 0)">
					CHARINDEX(#{item.key}
				</foreach>
			</if>
		) B
	</select>

	<!-- 차량별누적현황상세 - 정시도착률 -->
	<select id="carArrDtlAnalList" parameterType="map" resultType="box">
		SELECT
			  ROW_NUMBER() OVER(ORDER BY B.STD_DATE) AS RNUM
			, B.STD_DATE
			, B.ARR_NOR_CNT
			, B.ARR_VIO_CNT
			, CAST(B.ARR_NOR_RT AS NUMERIC(4, 1)) AS ARR_NOR_RT
			, B.ARR_AGENT_NOR_CNT
			, B.ARR_AGENT_VIO_CNT
			, CAST(B.ARR_AGENT_NOR_RT AS NUMERIC(4, 1)) AS ARR_AGENT_NOR_RT
			, ABS(CAST(B.ARR_NOR_RT - B.ARR_AGENT_NOR_RT AS NUMERIC(4, 1))) AS DIF_RT
			, B.CAR_ID
			, D.CENTER_NM
			, E.CD_NM AS COMPANY_NM
			, C.CAR_NO
			, C.DRV_NM
			, C.DRV_TEL_NO
			, C.DRV_HP_NO
			, B.BIZ_CD
			, F.CD_NM AS REST_NM
		FROM TB_CAR_STAT B
		INNER JOIN TB_CAR C WITH(NOLOCK)
			ON C.CAR_ID = B.CAR_ID
		INNER JOIN TB_CENTER D WITH(NOLOCK)
			ON D.CENTER_CD = C.CENTER_CD
		LEFT OUTER JOIN TB_CD E
			ON E.GRP_CD = 'COMPANY_CD'
			AND E.CD = C.COMPANY_CD
		LEFT OUTER JOIN TB_CD F
			ON F.GRP_CD = 'REST_CD'
			AND F.CD = B.REST_CD
		WHERE 1 = 1
		AND B.CAR_ID = #{carId}
		AND B.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
		AND B.BIZ_CD = #{srchBizCd}
	</select>

	<!-- 차량별누적현황상세 - 온도준수율 -->
	<select id="carTempDtlAnalList" parameterType="map" resultType="box">
		SELECT
			  ROW_NUMBER() OVER(ORDER BY B.STD_DATE) AS RNUM
			, B.STD_DATE
			, F.CD_NM AS REST_NM
			, B.TEMP_TOT_CNT AS TEMP_TOT_CNT1
			, B.TEMP_VIO_LONG_CNT
		    , CAST(IIF(B.TEMP_TOT_CNT = 0, 0, B.TEMP_NOR_CNT * 100.0 / B.TEMP_TOT_CNT) AS NUMERIC(4, 1)) AS TEMP_NOR_RT
			, B.TEMP_TOT_CNT AS TEMP_TOT_CNT2
			, B.TEMP_HACCP_VIO_LONG_CNT
			, CAST(IIF(B.TEMP_TOT_CNT = 0, 0, B.TEMP_HACCP_NOR_CNT * 100.0 / B.TEMP_TOT_CNT) AS NUMERIC(4, 1)) AS TEMP_HACCP_NOR_RT
			, B.STD_DATE
			, B.CAR_ID
			, D.CENTER_NM
			, E.CD_NM AS COMPANY_NM
			, C.CAR_NO
			, C.DRV_NM
			, C.DRV_TEL_NO
			, C.DRV_HP_NO
			, B.BIZ_CD
			, C.CH_CNT
		FROM TB_CAR_STAT B WITH(NOLOCK)
		INNER JOIN TB_CAR C WITH(NOLOCK)
			ON C.CAR_ID = B.CAR_ID
		INNER JOIN TB_CENTER D WITH(NOLOCK)
			ON D.CENTER_CD = C.CENTER_CD
		LEFT OUTER JOIN TB_CD E
			ON E.GRP_CD = 'COMPANY_CD'
			AND E.CD = C.COMPANY_CD
		LEFT OUTER JOIN TB_CD F
			ON F.GRP_CD = 'REST_CD'
			AND F.CD = B.REST_CD
		WHERE 1 = 1
		AND B.CAR_ID = #{carId}
		AND B.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
		AND B.BIZ_CD = #{srchBizCd}
	</select>

	<!-- 차량별누적현황상세 - 납품실적 -->
	<select id="carDeliDtlAnalList" parameterType="map" resultType="box">
		SELECT
		<choose>
			<when test='sortColumn != null and sortColumn != ""'>
				ROW_NUMBER() OVER(ORDER BY ${sortColumn} ${sortOrder}) AS RNUM
			</when>
			<otherwise>
				ROW_NUMBER() OVER(ORDER BY X.SHIP_NO, X.ZONE_TYPE) AS RNUM
			</otherwise>
		</choose>
			,X.STD_MD
			,X.CAR_NO
			,X.SHIP_NO
			,X.DELI_NO
			,X.AGENT_NM
			,X.ARR_EXPECT_DT
			,X.CVO_EXPECT
			,X.ARR_DT
			,X.STR_DT
			,X.ARR_GAP_MIN
			,X.AGENT_GAP_MIN
			,X.DELAY_YN
			,X.CRATE_INPUT_DT
			,X.SAP_IF_DT
			,X.CENTER_RDY_DT
			,X.DELIY_DT
			,X.ZONE_TYPE
		FROM (
			SELECT
				 STUFF(RIGHT(CONVERT(VARCHAR, A.DELIY_DT, 112), 4), 3, 0, '-') AS STD_MD
				,E.CAR_NO
				,A.SHIP_NO
				,B.DELI_NO
				,B.AGENT_NM
				,SUBSTRING(CONVERT(VARCHAR(19), C.ARR_EXPECT_DT, 120), 6, 11) AS ARR_EXPECT_DT
				,IIF(
					 DATEPART(WEEKDAY, C.ARR_EXPECT_DT) IN (1, 7)
					 , IIF(D.WEEKEND_FROM IS NULL, '', CONCAT(STUFF(D.WEEKEND_FROM, 3, 0, ':'), ' ~ ', STUFF(D.WEEKEND_TO, 3, 0, ':')))
					 , IIF(D.NORMAL_FROM IS NULL, '', CONCAT(STUFF(D.NORMAL_FROM, 3, 0, ':'), ' ~ ', STUFF(D.NORMAL_TO, 3, 0, ':')))
				 ) AS CVO_EXPECT
				,SUBSTRING(CONVERT(VARCHAR(19), C.ARR_DT, 120), 6, 11) AS ARR_DT
				,SUBSTRING(CONVERT(VARCHAR(19), C.START_DT, 120), 6, 11) AS STR_DT
				,IIF(C.ARR_GAP_SEC > 0 , CONCAT(C.ARR_GAP_SEC / 60 , '분'), '-') AS ARR_GAP_MIN
				,IIF(C.AGENT_GAP_SEC > 0 , CONCAT(C.AGENT_GAP_SEC / 60 , '분'), '-') AS AGENT_GAP_MIN
				,C.DELAY_YN
				,SUBSTRING(CONVERT(VARCHAR(19), F.CRATE_INPUT_DT, 120), 6, 11) AS CRATE_INPUT_DT
				,SUBSTRING(CONVERT(VARCHAR(19), G.SAP_IF_DT, 120), 6, 11) AS SAP_IF_DT
				,NULL AS CENTER_RDY_DT
				,CASE
					WHEN C.ARR_DT = A.DELIY_DT THEN SUBSTRING(CONVERT(VARCHAR(19), A.DELIY_DT, 120), 6, 11)
				END AS DELIY_DT
				,C.DEV_DT
				,C.ZONE_TYPE
			FROM TB_DELI A WITH(NOLOCK)
			INNER JOIN TB_DELI_DTL B WITH(NOLOCK)
				ON B.SHIP_NO = A.SHIP_NO
			INNER JOIN TB_CAR_ZONE_IO C WITH(NOLOCK)
				ON C.SHIP_NO = B.SHIP_NO
				AND C.AGENT_CD = B.AGENT_CD
				AND C.DELI_NO = B.DELI_NO
			INNER JOIN TB_AGENT D
				ON D.AGENT_CD = B.AGENT_CD
			INNER JOIN TB_CAR E WITH(NOLOCK)
				ON E.CAR_ID = A.CAR_ID
			OUTER APPLY (
				SELECT AA.IO_SAVE_FIRST_DT AS CRATE_INPUT_DT
				FROM TB_DELI_DTL AA WITH(NOLOCK)
				WHERE AA.SHIP_NO = B.SHIP_NO
				AND AA.AGENT_CD = B.AGENT_CD
				AND AA.DELI_NO = B.DELI_NO
				AND AA.IO_SAVE_YN = 'Y'
			) F
			OUTER APPLY (
				SELECT MAX(INSERT_DT) AS SAP_IF_DT
				FROM TB_SAP_IF_HIST AA WITH(NOLOCK)
				WHERE AA.SEND_DIV = 'U'
				AND AA.SHIP_NO = B.SHIP_NO
				AND AA.DELI_NO = B.DELI_NO
			) G
			WHERE A.CAR_ID = #{carId}
			AND A.DELIY_DT >= CAST(#{srchStrDt} AS DATETIME)
			AND A.DELIY_DT &lt; CAST(#{srchEndDt} AS DATETIME) + 1
			AND B.BIZ_CD = #{srchBizCd}

			UNION ALL
			SELECT
				 STUFF(RIGHT(CONVERT(VARCHAR, A.DELIY_DT, 112), 4), 3, 0, '-') AS STD_MD
				,E.CAR_NO
				,A.SHIP_NO
				,'' AS DELI_NO
				,CONCAT(D.AGENT_NM, IIF(C.ZONE_TYPE = '3', '(도착)', '(출발)')) AS AGENT_NM
				,'' AS ARR_EXPECT_DT
				,'' AS CVO_EXPECT
				,CASE
					WHEN C.ZONE_TYPE = '3' THEN SUBSTRING(CONVERT(VARCHAR(19), C.ARR_DT, 120), 6, 11)
				END AS ARR_DT
				,CASE
					WHEN C.ZONE_TYPE = '1' THEN SUBSTRING(CONVERT(VARCHAR(19), C.START_DT, 120), 6, 11)
				END AS STR_DT
				,'' AS ARR_GAP_MIN
				,'' AS AGENT_GAP_MIN
				,'' AS DELAY_YN
				,'' AS CRATE_INPUT_DT
				,'' AS SAP_IF_DT
				,IIF(C.ZONE_TYPE = '1', SUBSTRING(CONVERT(VARCHAR(19), A.CENTER_RDY_DT, 120), 6, 11), NULL) AS CENTER_RDY_DT
				,IIF(C.ZONE_TYPE = '1' AND F.CNT = 0, SUBSTRING(CONVERT(VARCHAR(19), A.DELIY_DT, 120), 6, 11), NULL) AS DELIY_DT
				,C.DEV_DT
				,C.ZONE_TYPE
			FROM TB_DELI A WITH(NOLOCK)
			INNER JOIN TB_CAR_ZONE_IO C WITH(NOLOCK)
				ON C.SHIP_NO = A.SHIP_NO
			INNER JOIN TB_AGENT D
				ON D.AGENT_CD = C.AGENT_CD
			INNER JOIN TB_CAR E WITH(NOLOCK)
				ON E.CAR_ID = A.CAR_ID
			OUTER APPLY (
				SELECT COUNT(*) AS CNT
				FROM TB_CAR_ZONE_IO XX WITH(NOLOCK)
				WHERE XX.SHIP_NO = A.SHIP_NO
				AND XX.CAR_ID = A.CAR_ID
				AND XX.ARR_DT = A.CENTER_RDY_DT
			) F
			WHERE A.CAR_ID = #{carId}
			AND A.DELIY_DT >= CAST(#{srchStrDt} AS DATETIME)
			AND A.DELIY_DT &lt; CAST(#{srchEndDt} AS DATETIME) + 1
			AND C.ZONE_TYPE IN ('1', '3')
			AND EXISTS (
				SELECT 1
				FROM TB_DELI_DTL AA WITH(NOLOCK)
				WHERE AA.SHIP_NO = A.SHIP_NO
				AND AA.BIZ_CD = #{srchBizCd}
			)
		) X
	</select>


	<!-- 차량운행현황 -->
	<select id="carAnalList" parameterType="map" resultType="box">
		SELECT
			  ROW_NUMBER() OVER(ORDER BY A.STD_DATE, C.CENTER_NM, B.DRV_NM) AS RNUM
			, CAST(A.STD_DATE AS DATE) AS STD_DATE
			, B.CENTER_CD
			, C.CENTER_NM
			, B.COMPANY_CD
			, D.CD_NM AS COMPANY_NM
			, B.AGENT_CD
			, E.AGENT_NM
			, B.CAR_ID
			, B.CAR_NO
			, B.DRV_NM
			, B.DRV_HP_NO
			, CASE
				WHEN A.DRV_SEC &lt; 3600 THEN CONCAT(A.DRV_SEC / 60, '분')
				ELSE CONCAT(A.DRV_SEC / 3600, '시간', IIF(A.DRV_SEC % 3600 &lt; 60, '', CONCAT(' ', A.DRV_SEC % 3600 / 60, '분')))
			  END AS DRV_TM
			, CONCAT(A.DRV_DIS, 'km') AS DRV_DIS
			, A.DRV_CNT
			, A.IDLE_CNT
			, A.OVER_SPD_CNT
			, A.BURST_SPD_CNT
			, A.DROP_SPD_CNT
		FROM TB_CAR_EVENT A WITH(NOLOCK)
		INNER JOIN TB_CAR B WITH(NOLOCK)
			ON B.CAR_ID = A.CAR_ID
		INNER JOIN TB_CENTER C WITH(NOLOCK)
			ON C.CENTER_CD = B.CENTER_CD
		LEFT OUTER JOIN TB_CD D WITH(NOLOCK)
			ON D.GRP_CD = 'COMPANY_CD'
			AND D.CD = B.COMPANY_CD
		LEFT OUTER JOIN TB_AGENT E WITH(NOLOCK)
			ON E.AGENT_CD = B.AGENT_CD
		WHERE A.STD_DATE BETWEEN #{srchStrDt} AND #{srchEndDt}
		<if test='!srchCenterCdList.isEmpty and srchCenterCdList.size != 0'>
			<foreach item="item" collection="srchCenterCdList" open="AND (" separator=", B.CENTER_CD) > 0 OR " close=", B.CENTER_CD) > 0)">
				CHARINDEX(#{item.key}
			</foreach>
		</if>
		<if test='srchWord != null and srchWord != ""'>
			<if test='srchMethod == "carNo"'>
				AND B.CAR_NO LIKE '%' + #{srchWord} + '%'
			</if>
		</if>
	</select>

	<!-- 채널 목록 -->
	<select id="agentChList" parameterType="map" resultType="box">
		SELECT
			  CONCAT('CH_', IIF(ETC1 IS NULL, 'NONE', ETC1)) AS CH
			, IIF(ETC1 IS NULL, '미지정', MAX(CD_NM)) AS CH_NM
			, COUNT(*) AS CNT
		FROM TB_CD
		WHERE GRP_CD = 'CH_CD'
		GROUP BY ETC1
		ORDER BY IIF(ETC1 IS NULL, 99, ETC1)
	</select>

	<!-- 물류 채녈별 정시 도착률 -->
	<select id="dayChArrAnalList" parameterType="map" resultType="box">
		WITH T1 AS (
			SELECT
				  A.CENTER_CD
				, A.CENTER_NM
				, CONCAT('CH_', IIF(D.ETC1 IS NULL, 'NONE', D.ETC1)) AS CH
				, COUNT(*) AS TOT_CNT
				, SUM(IIF(B.ARR_DT IS NOT NULL AND B.DELAY_YN = 'N', 1 , 0)) AS NOR_CNT
				, CAST(SUM(IIF(B.ARR_DT IS NOT NULL AND B.DELAY_YN = 'N', 1 , 0)) * 100.0 / COUNT(*) AS NUMERIC(4, 1)) AS NOR_RT
			FROM TB_DELI A WITH(NOLOCK)
			INNER JOIN TB_DELI_DTL B WITH(NOLOCK)
				ON B.SHIP_NO = A.SHIP_NO
			INNER JOIN TB_AGENT C WITH(NOLOCK)
				ON C.AGENT_CD = B.AGENT_CD
			LEFT OUTER JOIN TB_CD D WITH(NOLOCK)
				ON D.GRP_CD = 'CH_CD'
				AND D.CD = C.CH_CD
		<where>
			<if test='!srchCenterCdList.isEmpty and srchCenterCdList.size != 0'>
				<foreach item="item" collection="srchCenterCdList" open="AND (" separator=", A.CENTER_CD) > 0 OR " close=", A.CENTER_CD) > 0)">
					CHARINDEX(#{item.key}
				</foreach>
			</if>
			<if test='srchStrDt != null and srchStrDt != ""'>
				AND B.ARR_EXPECT_DT >= CONVERT(DATETIME, #{srchStrDt}, 112)
			</if>
			<if test='srchEndDt != null and srchEndDt != ""'>
				AND B.ARR_EXPECT_DT &lt; CONVERT(DATETIME, #{srchEndDt}, 112) + 1
			</if>
			AND B.BIZ_CD = #{srchBizCd}
		</where>
			GROUP BY A.CENTER_CD, A.CENTER_NM, D.ETC1
		),
		T2 AS (
			SELECT
				  CENTER_CD
				, CENTER_NM
				, IIF(
					   SUM(TOT_CNT) OVER(PARTITION BY CENTER_CD) = 0
					 , 0
					 , SUM(NOR_CNT) OVER(PARTITION BY CENTER_CD) * 100.0 / SUM(TOT_CNT) OVER(PARTITION BY CENTER_CD)
				  ) AS TOT_RT
		<if test='!agentChList.isEmpty and agentChList.size != 0'>
			<foreach item="item" collection="agentChList" open="" separator="" close="">
				, [${item.ch}]
			</foreach>
		</if>
			FROM T1
			PIVOT (
				MAX(NOR_RT)
				FOR CH IN (
		<if test='!agentChList.isEmpty and agentChList.size != 0'>
			<foreach item="item" collection="agentChList" open="" separator="," close="">
				[${item.ch}]
			</foreach>
		</if>
				)
			) PV
		)
		SELECT
			  ROW_NUMBER() OVER(ORDER BY CENTER_NM) AS RNUM
			, X.*
		FROM (
			SELECT
				  CENTER_CD
				, CENTER_NM
				, MAX(TOT_RT) AS TOT_RT
			<if test='!agentChList.isEmpty and agentChList.size != 0'>
				<foreach item="item" collection="agentChList" open="" separator="" close="">
					, MAX([${item.ch}]) AS [${item.ch}]
				</foreach>
			</if>
			FROM T2
			GROUP BY CENTER_CD, CENTER_NM
		) X
	</select>

	<!-- 물류 채녈별 세부 정시 도착률 -->
	<select id="dayChArrAnalDtlList" parameterType="map" resultType="box">
		SELECT
			  ROW_NUMBER() OVER(ORDER BY IIF(ETC1 IS NULL, 99, ETC1)) AS RNUM
			, X.*
		FROM (
			SELECT
				  A.CENTER_CD
				, A.CENTER_NM
				, D.ETC1
				, CONCAT('CH_', IIF(D.ETC1 IS NULL, 'NONE', D.ETC1)) AS CH
				, IIF(D.ETC1 IS NULL, '미지정', MAX(D.CD_NM)) AS CH_NM
				, COUNT(*) AS TOT_CNT
				, SUM(IIF(B.ARR_DT IS NOT NULL AND B.DELAY_YN = 'N', 1 , 0)) AS NOR_CNT
				, CAST(SUM(IIF(B.ARR_DT IS NOT NULL AND B.DELAY_YN = 'N', 1 , 0)) * 100.0 / COUNT(*) AS NUMERIC(4, 1)) AS NOR_RT
				, SUM(IIF(B.ARR_DT IS NULL, 0 , 1)) AS ARR_CNT
			FROM TB_DELI A WITH(NOLOCK)
			INNER JOIN TB_DELI_DTL B WITH(NOLOCK)
				ON B.SHIP_NO = A.SHIP_NO
			INNER JOIN TB_AGENT C WITH(NOLOCK)
				ON C.AGENT_CD = B.AGENT_CD
			LEFT OUTER JOIN TB_CD D WITH(NOLOCK)
				ON D.GRP_CD = 'CH_CD'
				AND D.CD = C.CH_CD
			WHERE A.CENTER_CD = #{centerCd}
			AND B.BIZ_CD = #{srchBizCd}
		<if test='srchStrDt != null and srchStrDt != ""'>
			AND B.ARR_EXPECT_DT >= CONVERT(DATETIME, #{srchStrDt}, 112)
		</if>
		<if test='srchEndDt != null and srchEndDt != ""'>
			AND B.ARR_EXPECT_DT &lt; CONVERT(DATETIME, #{srchEndDt}, 112) + 1
		</if>
			GROUP BY A.CENTER_CD, A.CENTER_NM, D.ETC1
		) X
	</select>

	<!-- 일자별 온도준수율 -->
	<select id="dayTempAnalList" parameterType="map" resultType="box">
		WITH T1 AS (
		    SELECT
				  A.CENTER_CD
		        , SUM(A.TEMP_TOT_CNT) AS TEMP_TOT_CNT
		        , SUM(A.TEMP_NOR_CNT) AS TEMP_NOR_CNT
				, SUM(A.TEMP_VIO_LONG_CNT) AS TEMP_VIO_LONG_CNT
		        , SUM(A.TEMP_HACCP_NOR_CNT) AS TEMP_HACCP_NOR_CNT
				, SUM(A.TEMP_HACCP_VIO_LONG_CNT) AS TEMP_HACCP_VIO_LONG_CNT
				, SUM(IIF(A.REST_CD = 'N', 1, 0)) AS NOR_CNT
				, SUM(IIF(A.REST_CD = '1', 1, 0)) AS REST_CNT
				, SUM(IIF(A.REST_CD = '2', 1, 0)) AS DEV_BKN_CNT
				, SUM(IIF(A.REST_CD = '3', 1, 0)) AS FIX_CNT
				, SUM(IIF(A.REST_CD = '4', 1, 0)) AS ETC_CNT
			FROM TB_CAR_STAT A
			INNER JOIN TB_CAR B WITH(NOLOCK)
				ON B.CAR_ID = A.CAR_ID
				AND B.USE_YN = 'Y'
				AND B.CENTER_CD IS NOT NULL
				AND (B.CAR_TID LIKE '012%' OR B.RENT_YN = 'Y')
			WHERE 1 = 1
			AND A.STD_DATE = #{srchDt}
			AND A.BIZ_CD = #{srchBizCd}
			<if test='!srchCenterCdList.isEmpty and srchCenterCdList.size != 0'>
				<foreach item="item" collection="srchCenterCdList" open="AND (" separator=", A.CENTER_CD) > 0 OR " close=", A.CENTER_CD) > 0)">
					CHARINDEX(#{item.key}
				</foreach>
			</if>
			GROUP BY A.CENTER_CD
		)
		SELECT
			  ROW_NUMBER() OVER(ORDER BY B.CENTER_NM) AS RNUM
			, A.CENTER_CD
			, B.CENTER_NM
			, A.REST_CNT
			, A.DEV_BKN_CNT
			, A.FIX_CNT
			, A.ETC_CNT
			, A.NOR_CNT
			, A.TEMP_TOT_CNT AS TEMP_TOT_CNT1
			, A.TEMP_VIO_LONG_CNT
			, CAST(IIF(A.TEMP_TOT_CNT = 0, 0, A.TEMP_NOR_CNT * 100.0 / A.TEMP_TOT_CNT) AS NUMERIC(4, 1)) AS TEMP_NOR_RT
			, A.TEMP_TOT_CNT AS TEMP_TOT_CNT2
			, A.TEMP_HACCP_VIO_LONG_CNT
			, CAST(IIF(A.TEMP_TOT_CNT = 0, 0, A.TEMP_HACCP_NOR_CNT * 100.0 / A.TEMP_TOT_CNT) AS NUMERIC(4, 1)) AS TEMP_HACCP_NOR_RT
			, CAST(IIF(A.TEMP_TOT_CNT = 0, 0, A.TEMP_NOR_CNT * 100.0 / A.TEMP_TOT_CNT) AS NUMERIC(4, 1))
				- CAST(IIF(A.TEMP_TOT_CNT = 0, 0, A.TEMP_HACCP_NOR_CNT * 100.0 / A.TEMP_TOT_CNT) AS NUMERIC(4, 1)) AS DIF_RT
		FROM T1 A
		LEFT OUTER JOIN TB_CENTER B WITH(NOLOCK)
			ON B.CENTER_CD = A.CENTER_CD
	</select>

	<!-- 일자별 온도 세부(차량) 준수율 -->
	<select id="dayTempAnalDtlList" parameterType="map" resultType="box">
		SELECT
			  ROW_NUMBER() OVER(ORDER BY A.CAR_ID) AS RNUM
			, A.STD_DATE
			, A.CAR_ID
			, A.CENTER_CD
			, C.CENTER_NM
			, B.COMPANY_CD
			, D.CD_NM AS COMPANY_NM
			, B.CAR_NO
			, B.DRV_NM
			, B.DRV_TEL_NO
			, B.DRV_HP_NO
			, A.REST_CD
			, E.CD_NM AS REST_NM
			, A.TEMP_TOT_CNT AS TEMP_TOT_CNT1
			, A.TEMP_VIO_LONG_CNT
			, CAST(IIF(A.TEMP_TOT_CNT = 0, 0, A.TEMP_NOR_CNT * 100.0 / A.TEMP_TOT_CNT) AS NUMERIC(4, 1)) AS TEMP_NOR_RT
			, A.TEMP_TOT_CNT AS TEMP_TOT_CNT2
			, A.TEMP_HACCP_VIO_LONG_CNT
			, CAST(IIF(A.TEMP_TOT_CNT = 0, 0, A.TEMP_HACCP_NOR_CNT * 100.0 / A.TEMP_TOT_CNT) AS NUMERIC(4, 1)) AS TEMP_HACCP_NOR_RT
			, A.BIZ_CD
		FROM TB_CAR_STAT A
		INNER JOIN TB_CAR B WITH(NOLOCK)
			ON B.CAR_ID = A.CAR_ID
		    AND B.USE_YN = 'Y'
			AND B.CENTER_CD IS NOT NULL
		    AND (B.CAR_TID LIKE '012%' OR B.RENT_YN = 'Y')
		LEFT OUTER JOIN TB_CENTER C WITH(NOLOCK)
			ON C.CENTER_CD = A.CENTER_CD
		LEFT OUTER JOIN TB_CD D
			ON D.GRP_CD = 'COMPANY_CD'
			AND D.CD = B.COMPANY_CD
		LEFT OUTER JOIN TB_CD E
			ON E.GRP_CD = 'REST_CD'
			AND E.CD = A.REST_CD
		WHERE A.CENTER_CD = #{centerCd}
		AND A.STD_DATE = #{srchDt}
		AND A.BIZ_CD = #{srchBizCd}
	</select>

	<!-- 일자별대리점 정시도착률; 센터단위 -->
	<select id="dayAgentArrAnalList" parameterType="map" resultType="box">
		WITH T1 AS (
		    SELECT
				  A.CENTER_CD
				, SUM(A.DELI_PLAN_CNT) AS DELI_PLAN_CNT
				, SUM(A.ARR_TOT_CNT) AS ARR_TOT_CNT
				, SUM(A.ARR_NOR_CNT) AS ARR_NOR_CNT
				, SUM(A.ARR_VIO_CNT) AS ARR_VIO_CNT
				, SUM(A.ARR_AGENT_NOR_CNT) AS ARR_AGENT_NOR_CNT
				, SUM(A.ARR_AGENT_VIO_CNT) AS ARR_AGENT_VIO_CNT
			FROM TB_CAR_STAT A
		    INNER JOIN TB_CAR B WITH(NOLOCK)
		    	ON B.CAR_ID = A.CAR_ID
				AND B.USE_YN = 'Y'
				AND B.CENTER_CD IS NOT NULL
				AND (B.CAR_TID LIKE '012%' OR B.RENT_YN = 'Y')
			WHERE 1 = 1
		  	AND A.REST_CD = 'N'
			AND A.STD_DATE = #{srchDt}
			AND A.BIZ_CD = #{srchBizCd}
			<if test='!srchCenterCdList.isEmpty and srchCenterCdList.size != 0'>
				<foreach item="item" collection="srchCenterCdList" open="AND (" separator=", A.CENTER_CD) > 0 OR " close=", A.CENTER_CD) > 0)">
					CHARINDEX(#{item.key}
				</foreach>
			</if>
			GROUP BY A.CENTER_CD
		)
		SELECT
			  ROW_NUMBER() OVER(ORDER BY B.CENTER_NM) AS RNUM
			, A.CENTER_CD
			, B.CENTER_NM
			, A.DELI_PLAN_CNT
			, A.ARR_TOT_CNT
		    , A.DELI_PLAN_CNT - A.ARR_TOT_CNT AS IN_COMP_CNT
			, A.ARR_NOR_CNT
			, A.ARR_VIO_CNT
			, CAST(IIF(A.ARR_TOT_CNT = 0, 0, A.ARR_NOR_CNT * 100.0 / A.ARR_TOT_CNT) AS NUMERIC(4, 1)) AS ARR_NOR_RT
			, A.ARR_AGENT_NOR_CNT
			, A.ARR_AGENT_VIO_CNT
			, CAST(IIF(A.ARR_TOT_CNT = 0, 0, A.ARR_AGENT_NOR_CNT * 100.0 / A.ARR_TOT_CNT) AS NUMERIC(4, 1)) AS ARR_AGENT_NOR_RT
			, CAST(IIF(A.ARR_TOT_CNT = 0, 0, A.ARR_AGENT_NOR_CNT * 100.0 / A.ARR_TOT_CNT)
				- IIF(A.ARR_TOT_CNT = 0, 0, A.ARR_NOR_CNT * 100.0 / A.ARR_TOT_CNT) AS NUMERIC(4, 1)) AS DIF_RT
		FROM T1 A
		INNER JOIN TB_CENTER B
			ON B.CENTER_CD = A.CENTER_CD
	</select>

	<!--  -->
	<select id="dayAgentArrAnalDtlList" parameterType="map" resultType="box">
		SELECT
			  ROW_NUMBER() OVER(ORDER BY A.CAR_ID) AS RNUM
			, A.STD_DATE
			, A.CAR_ID
			, A.CENTER_CD
			, C.CENTER_NM
			, D.CD_NM AS COMPANY_NM
			, B.CAR_NO
			, B.DRV_NM
			, B.DRV_TEL_NO
			, B.DRV_HP_NO
			, A.REST_CD
			, F.CD_NM AS REST_NM
			, A.ARR_TOT_CNT
			, A.ARR_NOR_CNT
			, A.ARR_VIO_CNT
			, CAST(A.ARR_NOR_RT AS NUMERIC(4, 1)) AS ARR_NOR_RT
			, A.ARR_AGENT_NOR_CNT
			, A.ARR_AGENT_VIO_CNT
			, CAST(A.ARR_AGENT_NOR_RT AS NUMERIC(4, 1)) AS ARR_AGENT_NOR_RT
			, CAST(A.ARR_NOR_RT - A.ARR_AGENT_NOR_RT AS NUMERIC(4, 1)) AS DIF_RT
		FROM TB_CAR_STAT A
		INNER JOIN TB_CAR B WITH (NOLOCK)
			ON B.CAR_ID = A.CAR_ID
		    AND B.USE_YN = 'Y'
			AND B.CENTER_CD IS NOT NULL
			AND (B.CAR_TID LIKE '012%' OR B.RENT_YN = 'Y')
		INNER JOIN TB_CENTER C
			ON C.CENTER_CD = A.CENTER_CD
		LEFT OUTER JOIN TB_CD D
			ON D.GRP_CD = 'COMPANY_CD'
			AND D.CD = B.COMPANY_CD
		LEFT OUTER JOIN TB_CD F
			ON F.GRP_CD = 'REST_CD'
			AND F.CD = A.REST_CD
		WHERE 1 = 1
		AND A.STD_DATE = #{srchDt}
		AND A.CENTER_CD = #{centerCd}
		AND A.BIZ_CD = #{srchBizCd}
	</select>

	<!--
	 -->
	<select id="dayCarTempAnalHistList" parameterType="map" resultType="box">
		WITH T1 AS (
		    SELECT
		          CAST(A.DELIY_DT AS DATE) AS STD_DATE
		        , A.CAR_ID
				, MIN(CASE
				      WHEN C.ZONE_TYPE = '1' THEN C.START_DT
				      WHEN C.ZONE_TYPE = '2' THEN ISNULL(C.ARR_DT, C.START_DT)
					END) AS MIN_DT
				, MAX(CASE
						WHEN C.ZONE_TYPE = '2' AND A.DELIY_DIV = '1' THEN C.ARR_DT
						WHEN C.ZONE_TYPE = '2' AND A.DELIY_DIV = '3' THEN A.DELIY_DT
						WHEN C.ZONE_TYPE = '2'
							THEN
								CASE
									WHEN C.ARR_DT > A.DELIY_DT THEN C.ARR_DT
									ELSE A.DELIY_DT
								END
					  END) AS MAX_DT
			FROM TB_DELI A WITH(NOLOCK)
			INNER JOIN TB_CAR_ZONE_IO C WITH(NOLOCK)
				ON C.SHIP_NO = A.SHIP_NO
			WHERE 1 = 1
			AND EXISTS (
			    SELECT 1
			    FROM TB_DELI_DTL BB WITH (NOLOCK)
				WHERE 1 = 1
				AND BB.BIZ_CD = #{bizCd}
				AND BB.SHIP_NO = A.SHIP_NO
			)
			AND C.CAR_ID = #{carId}
			AND DATEDIFF(DAY, CAST(#{stdDate} AS DATE), A.DELIY_DT) = 0
			AND (
				(C.ZONE_TYPE = '1' AND DATEDIFF(DAY, A.DELIY_DT, C.START_DT) = 0)
				OR (C.ZONE_TYPE IN ('2') AND DATEDIFF(DAY, A.DELIY_DT, C.ARR_DT) = 0)
			)
		    GROUP BY CAST(A.DELIY_DT AS DATE), A.CAR_ID, A.SHIP_NO
		)
		SELECT
			  ROW_NUMBER() OVER(ORDER BY A.DEV_DT) AS RNUM
			, CONVERT(VARCHAR, A.DEV_DT, 108) AS DEV_TM
			, A.JIBUN_ADDR
			, A.SPD
			, IIF(B.CH_CNT &lt; 1, NULL, CAST(A.CH1 / 10.0 AS NUMERIC(4, 1))) AS CH1
			, IIF(B.CH_CNT &lt; 2, NULL, CAST(A.CH2 / 10.0 AS NUMERIC(4, 1))) AS CH2
			, CASE
			    WHEN A.CH1 IS NULL AND A.CH2 IS NULL THEN '-'
				WHEN D1.VIO_CNT > 0 THEN '이상'
				ELSE '정상'
			  END AS MAEIL_TEMP_STAT1
		    , CASE
				WHEN D1.VIO_LONG_CNT > 0 THEN '위반'
			  END AS MAEIL_TEMP_STAT2
			, CASE
			    WHEN A.CH1 IS NULL AND A.CH2 IS NULL THEN '-'
				WHEN D2.VIO_CNT > 0 THEN '이상'
				ELSE '정상'
			  END AS HACCP_TEMP_STAT1
		    , CASE
				WHEN D2.VIO_LONG_CNT > 0 THEN '위반'
			  END AS HACCP_TEMP_STAT2
			, CASE ISNULL(C1.ZONE_TYPE, C2.ZONE_TYPE)
				WHEN '1' THEN '센터출발'
				WHEN '2' THEN CONCAT(E2.AGENT_NM, ' 도착')
				WHEN '3' THEN '센터도착'
			  END AS EVENT
			, ISNULL(C1.ZONE_TYPE, C2.ZONE_TYPE) AS ZONE_TYPE
			, ISNULL(E1.AGENT_NM, E2.AGENT_NM) AS AGENT_NM
			, C2.DELAY_YN
		FROM TB_CAR_HIST A WITH(NOLOCK)
		INNER JOIN TB_CAR B WITH(NOLOCK)
			ON B.CAR_ID = A.CAR_ID
		LEFT OUTER JOIN TB_CAR_ZONE_IO C1 WITH(NOLOCK)
			ON C1.CAR_ID = A.CAR_ID
			AND C1.START_DT = A.DEV_DT
			AND C1.ZONE_TYPE = '1'
		LEFT OUTER JOIN TB_CAR_ZONE_IO C2 WITH(NOLOCK)
			ON C2.CAR_ID = A.CAR_ID
			AND C2.ARR_DT = A.DEV_DT
			AND C2.ZONE_TYPE IN ('2', '3')
		LEFT OUTER JOIN TB_CAR_TEMP_VIO D1 WITH(NOLOCK)
			ON D1.CAR_ID = A.CAR_ID
			AND D1.DEV_DT = A.DEV_DT
			AND D1.EVT_FLAG = '1'
		LEFT OUTER JOIN TB_CAR_TEMP_VIO D2 WITH(NOLOCK)
			ON D2.CAR_ID = A.CAR_ID
			AND D2.DEV_DT = A.DEV_DT
			AND D2.EVT_FLAG = '2'
		LEFT OUTER JOIN TB_AGENT E1 WITH(NOLOCK)
			ON E1.AGENT_CD = C1.AGENT_CD
		LEFT OUTER JOIN TB_AGENT E2 WITH(NOLOCK)
			ON E2.AGENT_CD = C2.AGENT_CD
		WHERE 1 = 1
		AND A.LOG_DIV = 'D'
		AND A.CAR_ID = #{carId}
		AND DATEDIFF(DAY, A.DEV_DT, CAST(#{stdDate} AS DATE)) = 0
		AND EXISTS (
			SELECT 1
			FROM T1 Z
			WHERE Z.CAR_ID = A.CAR_ID
			AND Z.MIN_DT &lt;= A.DEV_DT
			AND Z.MAX_DT >= A.DEV_DT
			AND DATEDIFF(DAY, Z.STD_DATE, Z.MIN_DT) = 0
			AND DATEDIFF(DAY, Z.STD_DATE, Z.MAX_DT) = 0
		)
	</select>

	<select id="dayAgentArrAnalHistList" parameterType="map" resultType="box">
		WITH T1 AS (
		    SELECT
		        CAST(B.DELIY_DT AS DATE) AS STD_DATE,
				A.CAR_ID,
		        C.AGENT_CD,
				CASE
					WHEN C.ZONE_TYPE = '1' THEN C.START_DT
					WHEN C.ZONE_TYPE = '2' THEN C.ARR_DT
					WHEN C.ZONE_TYPE = '3' THEN C.ARR_DT
				END AS ZONE_DEV_DT,
		        CASE
					WHEN C.ZONE_TYPE = '1' THEN 13
					WHEN C.ZONE_TYPE = '2' THEN 22
					WHEN C.ZONE_TYPE = '3' THEN 32
				END AS ZONE_DEV_DT_DIV,
		        IIF(C.ZONE_TYPE = '2', C.DELAY_YN, NULL) AS DELAY_YN,
		        IIF(C.ZONE_TYPE = '2', C.AGENT_DELAY_YN, NULL) AS AGENT_DELAY_YN
			FROM TB_CAR A WITH(NOLOCK)
			INNER JOIN TB_DELI B WITH(NOLOCK)
				ON B.CAR_ID = A.CAR_ID
			INNER JOIN TB_CAR_ZONE_IO C WITH(NOLOCK)
				ON C.SHIP_NO = B.SHIP_NO
			LEFT OUTER JOIN TB_DELI_DTL D WITH(NOLOCK)
				ON D.SHIP_NO = C.SHIP_NO
				AND D.DELI_NO = C.DELI_NO
		    	AND D.BIZ_CD = #{bizCd}
			WHERE 1 = 1
			AND A.USE_YN = 'Y'
			AND A.CENTER_CD IS NOT NULL
			AND C.CAR_ID = #{carId}
			AND DATEDIFF(DAY, CAST(#{stdDate} AS DATE), B.DELIY_DT) = 0
			AND (
				(C.ZONE_TYPE = '1' AND DATEDIFF(DAY, B.DELIY_DT, C.START_DT) = 0)
				OR (C.ZONE_TYPE IN ('2', '3') AND DATEDIFF(DAY, B.DELIY_DT, C.ARR_DT) = 0)
			)

			UNION ALL
			SELECT
			    CAST(B.DELIY_DT AS DATE) AS STD_DATE,
				A.CAR_ID,
			    C.AGENT_CD,
				C.START_DT AS ZONE_DEV_DT,
			    23 AS ZONE_DEV_DT_DIV,
			    NULL AS DELAY_YN,
		        NULL AS AGENT_DELAY_YN
			FROM TB_CAR A WITH(NOLOCK)
			INNER JOIN TB_DELI B WITH(NOLOCK)
				ON B.CAR_ID = A.CAR_ID
			INNER JOIN TB_CAR_ZONE_IO C WITH(NOLOCK)
				ON C.SHIP_NO = B.SHIP_NO
			INNER JOIN TB_DELI_DTL D WITH(NOLOCK)
				ON D.SHIP_NO = C.SHIP_NO
				AND D.DELI_NO = C.DELI_NO
		    	AND D.BIZ_CD = #{bizCd}
			WHERE 1 = 1
			AND A.USE_YN = 'Y'
			AND A.CENTER_CD IS NOT NULL
			AND C.CAR_ID = #{carId}
			AND DATEDIFF(DAY, CAST(#{stdDate} AS DATE), B.DELIY_DT) = 0
			AND (
				(C.ZONE_TYPE IN ('2') AND DATEDIFF(DAY, B.DELIY_DT, C.START_DT) = 0)
			)
		)
		SELECT
			ROW_NUMBER() OVER(ORDER BY A.DEV_DT) AS RNUM,
			CONVERT(VARCHAR, A.DEV_DT, 108) AS DEV_TM,
			A.JIBUN_ADDR,
			A.SPD,
		    CASE
				WHEN ISNULL(A.DAY_TOT_DIS, 0) = 0 THEN ''
				WHEN A.DAY_TOT_DIS &lt; 1000 THEN CONCAT(A.DAY_TOT_DIS, 'm')
				ELSE CONCAT(CAST(A.DAY_TOT_DIS / 1000.0 AS NUMERIC(10, 1)), 'km')
			END AS DAY_TOT_DIS,
			CASE
				WHEN Z.DELAY_YN = 'Y' THEN '미준수'
				WHEN Z.DELAY_YN = 'N' THEN '준수'
				ELSE '-'
			END AS DELAY_STAT,
			CASE
				WHEN Z.AGENT_DELAY_YN = 'Y' THEN '미준수'
				WHEN Z.AGENT_DELAY_YN = 'N' THEN '준수'
				ELSE '-'
			END AS AGENT_DELAY_STAT,
			CONCAT(E.AGENT_NM, IIF(Z.ZONE_DEV_DT_DIV IN (22, 32), ' 도착', ' 출발')) AS EVENT
		FROM TB_CAR_HIST A WITH(NOLOCK)
		INNER JOIN T1 Z
		    ON Z.CAR_ID = A.CAR_ID
			AND Z.ZONE_DEV_DT = A.DEV_DT
		LEFT OUTER JOIN TB_AGENT E WITH(NOLOCK)
			ON E.AGENT_CD = Z.AGENT_CD
		WHERE 1 = 1
		AND A.LOG_DIV = 'D'
		AND A.CAR_ID = #{carId}
		AND DATEDIFF(DAY, A.DEV_DT, CAST(#{stdDate} AS DATE)) = 0
	</select>

</mapper>